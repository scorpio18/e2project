<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>e2 Tutorial &mdash; e2</title>
    
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="top" title="e2" href="index.html" />
    <link rel="up" title="e2 Quick Start" href="quick_start.html" />
    <link rel="next" title="Erlang Overview" href="erlang.html" />
    <link rel="prev" title="e2 Quick Start" href="quick_start.html" />
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30496899-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
    'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
  })();

</script> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="erlang.html" title="Erlang Overview"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="quick_start.html" title="e2 Quick Start"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">e2</a> &raquo;</li>
          <li><a href="overview.html" >e2 Overview</a> &raquo;</li>
          <li><a href="quick_start.html" accesskey="U">e2 Quick Start</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="e2-tutorial">
<h1>e2 Tutorial<a class="headerlink" href="#e2-tutorial" title="Permalink to this headline">¶</a></h1>
<p>e2 lets you use Erlang to build better quality software in less time. This
tutorial guide will walk you through an example of that process.</p>
<p>We’re done with “hello world” examples here – that’s way too easy. Let’s shoot
for something more interesting…</p>
<p>A database server!</p>
<p>Of course, there are hundreds of ready made databases we could use “off the
shelf”. Why tackle the hard problem ourselves?</p>
<p>Aside from the fact this is a tutorial and we’ll learn a lot, sometimes it just
makes sense to build something yourself.</p>
<p>The <em>build</em> vs. <em>buy</em> consideration is as old as the software industry
itself. The explosion of quality open source software gives us even more <em>buy</em>
options (even if we’re not paying for licenses). Changes are good that you’ll
find something on github that is close to meeting your needs.</p>
<p>The problem with buy options has always been that you’re taking a solution to
someone else’s problem and applying it to your own. You must often adapt the
off-the-shelf component to meet your needs – or, worse, adapt your needs to
the software!</p>
<p>In this tutorial example, we’ll demonstrate how you can use Erlang to build a
solution to your problem – it will contain no more or no less functionality
than we need.</p>
<div class="section" id="problem-definition">
<h2>Problem Definition<a class="headerlink" href="#problem-definition" title="Permalink to this headline">¶</a></h2>
<p>The single most important step in software development is understanding what
your problem is. In fact, that’s the real problem! Developers too often start
working on a solution without having a clear idea of what they’re solving.</p>
<p>Let’s not make that mistake!</p>
<p>Of course, this is an example, so we can make up any problem and be 100%
correct! But let’s at least make it sound good.</p>
<p>In this example, we’ll let multiple clients store and retrieve strings. We also
want to perform special validation on values before they’re stored. We could
use something like stored procedures in a relational database to implement
this, but let’s see how far we get with something very simple and direct.</p>
<p>Here’s what we’re looking for:</p>
<ul class="simple">
<li>Write values that can be subsequently read using a key</li>
<li>Ensure that illegal values aren’t written</li>
<li>Support multiple connected clients over a TCP network</li>
<li>Data should survive application restarts or crashes <a class="footnote-reference" href="#durability" id="id1">[1]</a></li>
</ul>
<p>With that problem sketch, let’s get started!</p>
</div>
<div class="section" id="setting-up-e2">
<h2>Setting Up e2<a class="headerlink" href="#setting-up-e2" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you’ve already setup e2 from <a class="reference internal" href="quick_start.html"><span class="doc">e2 Quick Start</span></a>, you can skip this
section. References to <code class="docutils literal notranslate"><span class="pre">E2_HOME</span></code> in this tutorial refer to the root
directory of your local e2 clone.</p>
</div>
<p>First, retrieve e2 from github:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone git://github.com/gar1t/e2.git
</pre></div>
</div>
<p>Note the e2 directory – we will refer to this as <code class="docutils literal notranslate"><span class="pre">E2_HOME</span></code> in examples. If
you want to copy-and-paste the examples, export the environment variable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ export E2_HOME=&lt;e2 directory&gt;
</pre></div>
</div>
<p>Compile e2:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd $E2_HOME
$ make
</pre></div>
</div>
</div>
<div class="section" id="create-an-empty-e2-project">
<h2>Create an Empty e2 Project<a class="headerlink" href="#create-an-empty-e2-project" title="Permalink to this headline">¶</a></h2>
<p>From <code class="docutils literal notranslate"><span class="pre">E2_HOME</span></code> use the <code class="docutils literal notranslate"><span class="pre">new-project</span></code> make target to create a new project
skeleton. We’ll call our application “mydb” <a class="footnote-reference" href="#mydb" id="id2">[2]</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd $E2_HOME
$ make new-project appid=mydb appdir=~/e2-tutorial
</pre></div>
</div>
<p>Compile your new project:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd ~/e2-tutorial
$ make
</pre></div>
</div>
<p>Run your project in an Erlang shell:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make shell
</pre></div>
</div>
<p>You can leave this shell running to experiment with your application as you
build it!</p>
</div>
<div class="section" id="developer-workflow">
<h2>Developer Workflow<a class="headerlink" href="#developer-workflow" title="Permalink to this headline">¶</a></h2>
<p>The most typical e2 workflow looks like this:</p>
<ul class="simple">
<li>Use a text editor to create and modify Erlang source files</li>
<li>Run the <code class="docutils literal notranslate"><span class="pre">make</span></code> or <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">quick</span></code> commands to compile changes</li>
<li>Experiment with your modules in the Erlang shell</li>
</ul>
<p>The e2 makefile’s <code class="docutils literal notranslate"><span class="pre">shell</span></code> target runs an Erlang shell with <code class="docutils literal notranslate"><span class="pre">e2_reloader</span></code>
started <a class="footnote-reference" href="#e2-reloader" id="id3">[3]</a>. <code class="docutils literal notranslate"><span class="pre">e2_reloader</span></code> watches for changes in your compiled
modules and automatically reloads them. It makes iterative development very
easy!</p>
<p>Let’s take this workflow for a test drive!</p>
<p>Open the <code class="docutils literal notranslate"><span class="pre">mydb.erl</span></code> module and modify the <code class="docutils literal notranslate"><span class="pre">stop</span></code> function from this:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">stop</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nn">application</span><span class="p">:</span><span class="nf">stop</span><span class="p">(</span><span class="n">mydb</span><span class="p">).</span>
</pre></div>
</div>
<p>to this:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">stop</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;### stopping mydb</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">),</span>
    <span class="nn">application</span><span class="p">:</span><span class="nf">stop</span><span class="p">(</span><span class="n">mydb</span><span class="p">).</span>
</pre></div>
</div>
<p>Save you changes and compile them by running the <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">quick</span></code> command
<a class="footnote-reference" href="#make-quick" id="id4">[4]</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make quick
</pre></div>
</div>
<p>This will recompile any modified modules, which in turn will be reloaded (if
need be) in the shell.</p>
<p>Test your change in the shell:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">mydb</span><span class="p">:</span><span class="n">stop</span><span class="p">()</span><span class="o">.</span>
<span class="c1">### stopping mydb</span>
<span class="p">{</span><span class="n">error</span><span class="p">,{</span><span class="n">not_started</span><span class="p">,</span><span class="n">mydb</span><span class="p">}}</span>
</pre></div>
</div>
<p>You get an error because the <code class="docutils literal notranslate"><span class="pre">mydb</span></code> application isn’t started. That’s okay –
this is just an illustration of developer workflow.</p>
<p>Here we used <a class="reference external" href="http://www.erlang.org/doc/man/io.html#format-1">io:format/1</a> to print something to the shell – as it turns out,
that’s a very useful way to debug your applications!</p>
<p>Let’s revert that change by deleting the <code class="docutils literal notranslate"><span class="pre">io:format(&quot;###</span> <span class="pre">stopping</span> <span class="pre">mydb~n&quot;),</span></code>
line and recompiling.</p>
<p>Note that the change is automatically reflected in your Erlang shell:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">mydb</span><span class="p">:</span><span class="n">stop</span><span class="p">()</span><span class="o">.</span>
<span class="p">{</span><span class="n">error</span><span class="p">,{</span><span class="n">not_started</span><span class="p">,</span><span class="n">mydb</span><span class="p">}}</span>
</pre></div>
</div>
</div>
<div class="section" id="building-a-database-server-where-to-start">
<h2>Building a Database Server - Where to Start?<a class="headerlink" href="#building-a-database-server-where-to-start" title="Permalink to this headline">¶</a></h2>
<p>Now that we have a project up and running, we can start to tackle our
problem. But where do we start?</p>
<p>When faced with a hard problem, it’s a good idea to look for smaller problems
that are easier to solve.</p>
<p>Without thinking at all about how the pieces should fit together, let’s jot
down some information that we’re fairly certain of. We don’t need to get it all
right – let’s just think out loud:</p>
<ul class="simple">
<li>We need a way to store the key/value pairs on disk and retrieve them</li>
<li>We need something to listen to a TCP socket and handle client connections</li>
</ul>
<p>Anything else?</p>
<p>Who cares! That’s certainly enough to get started. We could spend ages
perfecting a design, or dive right in, solve easy problems by experimentation,
and worry about the rest after we’ve made some progress.</p>
</div>
<div class="section" id="storage-engine">
<h2>Storage Engine<a class="headerlink" href="#storage-engine" title="Permalink to this headline">¶</a></h2>
<p>If we’re going to store strings values and associate them with keys, we’ll need
some sort of storage engine.</p>
<p>While we could be really ambitious and write our own, Erlang happens to have
something that we can start with – the <a class="reference external" href="http://www.erlang.org/doc/man/dets.html">dets module</a>.</p>
<p>Take a moment to scan through the documentation on <code class="docutils literal notranslate"><span class="pre">dets</span></code>. This may also be a
good time to glance over the <a class="reference internal" href="erlang_modules.html"><span class="doc">list of frequently used modules</span></a>. Erlang is a language with “batteries included” and it will
help you to know what’s available.</p>
<p>There’s a lot of detail in the <code class="docutils literal notranslate"><span class="pre">dets</span></code> module – let’s sketch out what we
might need before doing a deep dive:</p>
<ul class="simple">
<li>Write a keyed value</li>
<li>Retrieve a value with a key</li>
<li>Delete a keyed value</li>
<li>Manage concurrent access</li>
</ul>
<p>The last point comes up because we want to let more than one client access the
database at the same time.</p>
<p>Note the statement in the <code class="docutils literal notranslate"><span class="pre">dets</span></code> documentation:</p>
<blockquote>
<div><em>[The] Mnesia application (or some user implemented method for locking) has
to be used to implement safe concurrency.</em></div></blockquote>
<p>This is good to know! We’ll need to consider this when accessing any <code class="docutils literal notranslate"><span class="pre">dets</span></code>
files.</p>
</div>
<div class="section" id="data-access-api">
<h2>Data Access API<a class="headerlink" href="#data-access-api" title="Permalink to this headline">¶</a></h2>
<p>With your editor, create the file <code class="docutils literal notranslate"><span class="pre">~/e2-tutorial/src/mydb_db.erl</span></code> as follows:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">mydb_db</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">open</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="nb">put</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="nb">get</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">del</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>

<span class="nf">open</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">todo_open_dets_file</span><span class="p">,</span> <span class="nv">File</span><span class="p">}.</span>

<span class="nb">put</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">todo_put_val</span><span class="p">,</span> <span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">}.</span>

<span class="nb">get</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">todo_read_val</span><span class="p">,</span> <span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">}.</span>

<span class="nf">del</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">todo_delete_val</span><span class="p">,</span> <span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">}.</span>
</pre></div>
</div>
<p>This is our basic data API. Let’s implement one function at a time.</p>
<div class="section" id="creating-a-new-data-file">
<h3>Creating a New Data File<a class="headerlink" href="#creating-a-new-data-file" title="Permalink to this headline">¶</a></h3>
<p>Looking through the documentation, it looks like <a class="reference external" href="http://www.erlang.org/doc/man/dets.html#open_file-2">dets:open_file/2</a> is what we
need for both creating and opening an data file.</p>
<p>Update the <code class="docutils literal notranslate"><span class="pre">open/1</span></code> function to look like this:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">open</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">dets</span><span class="p">:</span><span class="nf">open_file</span><span class="p">(</span><span class="nv">File</span><span class="p">,</span> <span class="p">[]).</span>
</pre></div>
</div>
<p>That sure looks simple! As it turns out – the default options for
opening/creating the dets file should work for our application.</p>
</div>
<div class="section" id="inserting-new-items">
<h3>Inserting New Items<a class="headerlink" href="#inserting-new-items" title="Permalink to this headline">¶</a></h3>
<p>It’s looks like we want the <a class="reference external" href="http://www.erlang.org/doc/man/dets.html#insert-2">dets:insert/2</a> function for adding values to a
<code class="docutils literal notranslate"><span class="pre">dets</span></code> file.</p>
<p>Modify our <code class="docutils literal notranslate"><span class="pre">put/3</span></code> function to look like this:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nb">put</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">dets</span><span class="p">:</span><span class="nf">insert</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="p">{</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">}).</span>
</pre></div>
</div>
<p>Also very simple!</p>
</div>
<div class="section" id="retrieving-items">
<h3>Retrieving Items<a class="headerlink" href="#retrieving-items" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">dets</span></code> provides a dizzying array of lookup functions. Fortunately, our case is
very simple – we can use <a class="reference external" href="http://www.erlang.org/doc/man/dets.html#lookup-2">dets:lookup/2</a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">get/2</span></code> should now look like this:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nb">get</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">dets</span><span class="p">:</span><span class="nf">lookup</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">).</span>
</pre></div>
</div>
</div>
<div class="section" id="deleting-items">
<h3>Deleting Items<a class="headerlink" href="#deleting-items" title="Permalink to this headline">¶</a></h3>
<p>Our last function will use <a class="reference external" href="http://www.erlang.org/doc/man/dets.html#delete-2">dets:delete/2</a>:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">del</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">dets</span><span class="p">:</span><span class="nf">delete</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">).</span>
</pre></div>
</div>
</div>
<div class="section" id="testing-the-api">
<h3>Testing the API<a class="headerlink" href="#testing-the-api" title="Permalink to this headline">¶</a></h3>
<p>Compile your changes and, assuming there are no errors, let’s try some database
operations!</p>
<p>In your running Erlang shell:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">Db</span><span class="p">}</span> <span class="o">=</span> <span class="n">mydb_db</span><span class="p">:</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/tmp/test.db&quot;</span><span class="p">)</span><span class="o">.</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="s2">&quot;/tmp/test.db&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>This operation should have created the file <code class="docutils literal notranslate"><span class="pre">/tmp/test.db</span></code>.</p>
<p>You can use <a class="reference external" href="http://www.erlang.org/doc/man/file.html#read_file_info-2">file:read_file_info/1</a> within the Erlang shell to confirm.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">rr</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span>
<span class="p">[</span><span class="n">file_descriptor</span><span class="p">,</span><span class="n">file_info</span><span class="p">]</span>
<span class="o">&gt;</span> <span class="n">file</span><span class="p">:</span><span class="n">read_file_info</span><span class="p">(</span><span class="s2">&quot;/tmp/test.db&quot;</span><span class="p">)</span><span class="o">.</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="c1">#file_info{...}}</span>
</pre></div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">rr/1</span></code> is used to load Erlang record definitions into the shell
<a class="footnote-reference" href="#rr" id="id5">[5]</a>.</p>
<p>Now let’s have some fun!</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">mydb_db</span><span class="p">:</span><span class="n">put</span><span class="p">(</span><span class="n">Db</span><span class="p">,</span> <span class="s2">&quot;msg&quot;</span><span class="p">,</span> <span class="s2">&quot;Erlang is fun!&quot;</span><span class="p">)</span><span class="o">.</span>
<span class="n">ok</span>
<span class="o">&gt;</span> <span class="n">mydb_db</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">Db</span><span class="p">,</span> <span class="s2">&quot;msg&quot;</span><span class="p">)</span><span class="o">.</span>
<span class="p">[{</span><span class="s2">&quot;msg&quot;</span><span class="p">,</span><span class="s2">&quot;Erlang is fun!&quot;</span><span class="p">}]</span>
<span class="o">&gt;</span> <span class="n">mydb_db</span><span class="p">:</span><span class="k">del</span><span class="p">(</span><span class="n">Db</span><span class="p">,</span> <span class="s2">&quot;msg&quot;</span><span class="p">)</span><span class="o">.</span>
<span class="n">ok</span>
<span class="o">&gt;</span> <span class="n">mydb_db</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">Db</span><span class="p">,</span> <span class="s2">&quot;msg&quot;</span><span class="p">)</span><span class="o">.</span>
<span class="p">[]</span>
</pre></div>
</div>
<p>If you happened to mis-type something and get an error, you’ll notice that
subsequent uses of <code class="docutils literal notranslate"><span class="pre">Db</span></code> cause a strange error.</p>
<p>Let’s make a mistake:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">mydb_db</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">Db2</span><span class="p">,</span> <span class="s2">&quot;msg&quot;</span><span class="p">)</span><span class="o">.</span>
<span class="o">*</span> <span class="mi">1</span><span class="p">:</span> <span class="n">variable</span> <span class="s1">&#39;Db2&#39;</span> <span class="ow">is</span> <span class="n">unbound</span>
</pre></div>
</div>
<p>And correct it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">mydb_db</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">Db</span><span class="p">,</span> <span class="s2">&quot;msg&quot;</span><span class="p">)</span><span class="o">.</span>
<span class="o">**</span> <span class="n">exception</span> <span class="n">error</span><span class="p">:</span> <span class="n">bad</span> <span class="n">argument</span>
     <span class="ow">in</span> <span class="n">function</span>  <span class="n">dets</span><span class="p">:</span><span class="n">lookup</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">called</span> <span class="k">as</span> <span class="n">dets</span><span class="p">:</span><span class="n">lookup</span><span class="p">(</span><span class="s2">&quot;/tmp/test.db&quot;</span><span class="p">,</span><span class="s2">&quot;msg&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This is a not-so-obvious, but very useful feature in Erlang! Alas, the details
are out of scope for this tutorial.</p>
<p>When this happens, you can re-create the <code class="docutils literal notranslate"><span class="pre">Db</span></code> variable this way: <a class="footnote-reference" href="#reassign" id="id6">[6]</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">Db</span><span class="p">}</span> <span class="o">=</span> <span class="n">mydb_db</span><span class="p">:</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/tmp/test.db&quot;</span><span class="p">)</span><span class="o">.</span>
</pre></div>
</div>
</div>
<div class="section" id="refining-the-api">
<h3>Refining the API<a class="headerlink" href="#refining-the-api" title="Permalink to this headline">¶</a></h3>
<p>So far, we have a way to store and retrieve string values!</p>
<p>But our API is a bit strange:</p>
<ul class="simple">
<li>When we read our sample value, we got <code class="docutils literal notranslate"><span class="pre">[{&quot;msg&quot;,&quot;Erlang</span> <span class="pre">is</span> <span class="pre">fun!&quot;}]</span></code> – that
might make sense for <code class="docutils literal notranslate"><span class="pre">dets:lookup/2</span></code> but it’s a bit odd for our case</li>
<li>The “missing” value was <code class="docutils literal notranslate"><span class="pre">[]</span></code> – also odd</li>
</ul>
<p>Other than that, the API looks pretty good.</p>
<p>Let’s fix these two oddities by applying a standard Erlang pattern: we want a
way to differentiate “I have a value” from “I don’t have a value”. This is
typically done using Erlang atoms as follows:</p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">{ok,</span> <span class="pre">Value}</span></code></dt>
<dd>Indicates that we got a value</dd>
<dt><code class="docutils literal notranslate"><span class="pre">error</span></code></dt>
<dd>Indicates that we didn’t get a value</dd>
</dl>
<p>This pattern is used by <a class="reference external" href="http://www.erlang.org/doc/man/dict.html#find-2">dict:find/2</a> <a class="footnote-reference" href="#api-consistency" id="id7">[7]</a>.</p>
<p>Let’s modify <code class="docutils literal notranslate"><span class="pre">mydb_db:get/2</span></code> to use a result handler – the handler will be
responsible for translating the result from <code class="docutils literal notranslate"><span class="pre">dets:lookup/2</span></code> to something more
appropriate for our case.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nb">get</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_dets_lookup</span><span class="p">(</span><span class="nn">dets</span><span class="p">:</span><span class="nf">lookup</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">)).</span>
</pre></div>
</div>
<p>And add <code class="docutils literal notranslate"><span class="pre">handle_dets_lookup/1</span></code> to the module:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">handle_dets_lookup</span><span class="p">([{_</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Value</span><span class="p">};</span>
<span class="nf">handle_dets_lookup</span><span class="p">([])</span> <span class="o">-&gt;</span> <span class="n">error</span><span class="p">.</span>
</pre></div>
</div>
<p>Recompile your changes and test the new behavior:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">mydb_db</span><span class="p">:</span><span class="n">put</span><span class="p">(</span><span class="n">Db</span><span class="p">,</span> <span class="s2">&quot;msg&quot;</span><span class="p">,</span> <span class="s2">&quot;Erlang is elegant!&quot;</span><span class="p">)</span><span class="o">.</span>
<span class="n">ok</span>
<span class="o">&gt;</span> <span class="n">mydb_db</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">Db</span><span class="p">,</span> <span class="s2">&quot;msg&quot;</span><span class="p">)</span><span class="o">.</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="s2">&quot;Erlang is elegant!&quot;</span><span class="p">}</span>
<span class="o">&gt;</span> <span class="n">mydb_db</span><span class="p">:</span><span class="k">del</span><span class="p">(</span><span class="n">Db</span><span class="p">,</span> <span class="s2">&quot;msg&quot;</span><span class="p">)</span><span class="o">.</span>
<span class="n">ok</span>
<span class="o">&gt;</span> <span class="n">mydb_db</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">Db</span><span class="p">,</span> <span class="s2">&quot;msg&quot;</span><span class="p">)</span><span class="o">.</span>
<span class="n">error</span>
</pre></div>
</div>
<p>Nice!</p>
</div>
<div class="section" id="what-about-case">
<h3>What About <code class="docutils literal notranslate"><span class="pre">case</span></code>?<a class="headerlink" href="#what-about-case" title="Permalink to this headline">¶</a></h3>
<p>We could have written <code class="docutils literal notranslate"><span class="pre">get/2</span></code> this way:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nb">get</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="nn">dets</span><span class="p">:</span><span class="nf">lookup</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">)</span> <span class="k">of</span>
        <span class="p">[{_</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">}]</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Value</span><span class="p">};</span>
        <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">error</span>
    <span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
<p>Why did we use a “handler” function instead?</p>
<p>Any case statement can be translated into a function – and, in most cases,
that’s probably the better approach. A function lets you formalize the
operation. For one, you need to answer the question, “what am I going to call
this silly thing?” That process alone is helpful – naming things is hard, but
good names help clarify what’s going on.</p>
<p>You may also find the “case” worthy of a function if it becomes complex
enough.</p>
<p>Of course, you’re perfectly free to use case statements. But you should at
least feel a little guilty – you’re missing a great chance to clarify what
you’re doing with a well defined function!</p>
</div>
</div>
<div class="section" id="client-access">
<h2>Client Access<a class="headerlink" href="#client-access" title="Permalink to this headline">¶</a></h2>
<p>Now that we have a way to store and retrieve values, wouldn’t it be nice to let
clients access this great functionality?</p>
<p>But how?</p>
<p>We’ve already stated that we want clients to access our database over
TCP/IP. We could, for example, run an HTTP server and provide a <a class="reference external" href="http://en.wikipedia.org/wiki/Representational_state_transfer">REST</a>
interface for clients.</p>
<p>But why do that? TCP isn’t that hard after all. And we can use <code class="docutils literal notranslate"><span class="pre">telnet</span></code> to
test!</p>
<p>Let’s imagine for a moment a hypothetical <code class="docutils literal notranslate"><span class="pre">telnet</span></code> session with our database
server, running locally on port 1234. In the sample session below, lines
preceded with “&gt;&gt; ” are lines you would type followed by ENTER and the rest are
lines that telnet prints. The <code class="docutils literal notranslate"><span class="pre">^</span></code> character indicates the CTRL character is
held down when typing the following character.</p>
<p>Again, this is only a hypothetical “what it might look like”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ telnet 127.0.0.1 1234
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is &#39;^]&#39;.
&gt;&gt; PUT msg Erlang gives you mad skills
+OK
&gt;&gt; GET msg
+Erlang gives you mad skills
&gt;&gt; DEL msg
+OK
&gt;&gt; GET msg
-ERROR
&gt;&gt; ^]
&gt;&gt; quit
Connection closed.
</pre></div>
</div>
<p>This is a rough sketch, but you get the idea:</p>
<ul class="simple">
<li>Commands are sent on a single line (i.e. a series of bytes terminated by
“\r\n”)</li>
<li>Results are prefixed with “+” – errors are prefixed with “-“</li>
</ul>
</div>
<div class="section" id="database-server-stub">
<h2>Database Server Stub<a class="headerlink" href="#database-server-stub" title="Permalink to this headline">¶</a></h2>
<p>Let’s not think too much here – we know that we need two parts here:</p>
<ul class="simple">
<li>Something listening on a TCP port for incoming client connections</li>
<li>Something to handle client connections</li>
</ul>
<p>Each of these “somethings” maps to an <a class="reference internal" href="tasks.html"><span class="doc">e2 task</span></a>. Tasks are single
minded processes – they perform some work and stop, or, if need be, start the
work again.</p>
<p>In the case of the “listener”, we want a task that binds to a local port, waits
for a connection, starts a handler for that connection, and resumes the process
of waiting for another connection.</p>
<p>In the case of the “handler”, we want a task that interacts with a client
connection until that connection is closed or there’s an error.</p>
</div>
<div class="section" id="database-server-listener">
<h2>Database Server Listener<a class="headerlink" href="#database-server-listener" title="Permalink to this headline">¶</a></h2>
<p>Create the file <code class="docutils literal notranslate"><span class="pre">~/e2-tutorial/src/mydb_server.erl</span></code>:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">mydb_server</span><span class="p">).</span>

<span class="p">-</span><span class="ni">behavior</span><span class="p">(</span><span class="n">e2_task</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start_link</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle_task</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="nf">start_link</span><span class="p">(</span><span class="nv">Port</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">e2_task</span><span class="p">:</span><span class="nf">start_link</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="nv">Port</span><span class="p">).</span>

<span class="nf">init</span><span class="p">(</span><span class="nv">Port</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">listen</span><span class="p">(</span><span class="nv">Port</span><span class="p">)}.</span>

<span class="nf">handle_task</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">dispatch_client</span><span class="p">(</span><span class="n">wait_for_client</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)),</span>
    <span class="p">{</span><span class="n">repeat</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}.</span>

<span class="nf">listen</span><span class="p">(_</span><span class="nv">Port</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">fake_listen_socket</span><span class="p">.</span>

<span class="nf">wait_for_client</span><span class="p">(_</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">timer</span><span class="p">:</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">5000</span><span class="p">),</span>
    <span class="n">fake_client_socket</span><span class="p">.</span>

<span class="nf">dispatch_client</span><span class="p">(</span><span class="nv">Client</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;TODO: dispatch client </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Client</span><span class="p">]).</span>
</pre></div>
</div>
<p>Whoa – that’s a lot of code!</p>
<p>Before we break it down, let’s try it. First, compile your changes. Then run
the following in the Erlang shell:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">Server</span><span class="p">}</span> <span class="o">=</span> <span class="n">mydb_server</span><span class="p">:</span><span class="n">start_link</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span><span class="o">.</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span><span class="n">XX</span><span class="p">,</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">}</span>
</pre></div>
</div>
<p>And… wait for it…</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TODO</span><span class="p">:</span> <span class="n">dispatch</span> <span class="n">client</span> <span class="n">fake_client_socket</span>
<span class="n">TODO</span><span class="p">:</span> <span class="n">dispatch</span> <span class="n">client</span> <span class="n">fake_client_socket</span>
<span class="o">...</span>
</pre></div>
</div>
<p>This will continue running, simulating the client dispatch process, until we
stop it. Let’s terminate our task:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">exit</span><span class="p">(</span><span class="n">Server</span><span class="p">,</span> <span class="n">shutdown</span><span class="p">)</span><span class="o">.</span>
<span class="o">**</span> <span class="n">exception</span> <span class="n">exit</span><span class="p">:</span> <span class="n">shutdown</span>
</pre></div>
</div>
<p>We now have a “listener” that doesn’t really listen to anything – but it does
stub out the functionality we want. Let’s look more closely.</p>
<div class="section" id="task-behavior">
<h3>Task Behavior<a class="headerlink" href="#task-behavior" title="Permalink to this headline">¶</a></h3>
<p>We know our listener is a <cite>task</cite> because it says so:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">behavior</span><span class="p">(</span><span class="n">e2_task</span><span class="p">).</span>
</pre></div>
</div>
<p>Not only does this tell us what sort of module we have, it tells the Erlang
compiler to warn us if we don’t export certain functions – in this case, we
need to export <code class="docutils literal notranslate"><span class="pre">handle_task/1</span></code>.</p>
</div>
<div class="section" id="task-exports">
<h3>Task Exports<a class="headerlink" href="#task-exports" title="Permalink to this headline">¶</a></h3>
<p>We took the trouble to create two lists of exports for our module:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start_link</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle_task</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
</pre></div>
</div>
<p>We didn’t need to do this – but it’s a common pattern in Erlang to list
<em>public API</em> exports separately from <em>behavior callbacks</em>. In our handler task,
<code class="docutils literal notranslate"><span class="pre">start_link/1</span></code> is meant for public consumption, which <code class="docutils literal notranslate"><span class="pre">init/1</span></code> and
<code class="docutils literal notranslate"><span class="pre">handle_task/1</span></code> are callbacks that are used by <code class="docutils literal notranslate"><span class="pre">e2_task</span></code> <a class="footnote-reference" href="#callbacks" id="id8">[8]</a>.</p>
</div>
<div class="section" id="starting-the-task">
<h3>Starting the Task<a class="headerlink" href="#starting-the-task" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">start_link/1</span></code> is called to start our server. It takes one argument – the
port to listen on.</p>
<p>As a behavior callback module, <code class="docutils literal notranslate"><span class="pre">mydb_server</span></code> delegates <em>start</em> to its
behavior module – in this case <code class="docutils literal notranslate"><span class="pre">e2_task</span></code>.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">start_link</span><span class="p">(</span><span class="nv">Port</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">e2_task</span><span class="p">:</span><span class="nf">start_link</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="nv">Port</span><span class="p">).</span>
</pre></div>
</div>
<p>Here we provide the callback module <code class="docutils literal notranslate"><span class="pre">?MODULE</span></code>, which is an alias for the
<code class="docutils literal notranslate"><span class="pre">mydb_server</span></code>, and the port we want to listen on. The module will be used
when calling functions like <code class="docutils literal notranslate"><span class="pre">init/1</span></code> and <code class="docutils literal notranslate"><span class="pre">handle_task/1</span></code>. The port will be
used as an argument to <code class="docutils literal notranslate"><span class="pre">init/1</span></code>.</p>
</div>
<div class="section" id="initializing-the-task">
<h3>Initializing the Task<a class="headerlink" href="#initializing-the-task" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">init/1</span></code> is used to listen on the specified port:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">init</span><span class="p">(</span><span class="nv">Port</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">listen</span><span class="p">(</span><span class="nv">Port</span><span class="p">)}.</span>
</pre></div>
</div>
<p>The init result defines the initial task <em>state</em>, which is used in the first
call to <code class="docutils literal notranslate"><span class="pre">handle_task/1</span></code>.</p>
<p>What’s the point of a separate <em>init</em> phase – why not consolidate the startup
logic in the “start” function?</p>
<p>This is a nuanced point that gets to the heart of Erlang’s application
architecture: functions are called in the context of <em>processes</em>. Sometimes
functions are called in the context of a <em>client</em> process – and sometimes
they’re called in the context of a <em>server</em> process.</p>
<p>It’s important to understand and recognize this distinction.</p>
<p><code class="docutils literal notranslate"><span class="pre">start_link/1</span></code> is called in the context of the client process. <code class="docutils literal notranslate"><span class="pre">init/1</span></code> is
called in the context of the server process. A general rule in Erlang is this:
processes are black boxes – you start them and they run. All the grimy details
associated with the process are performed by the process – and die with the
process. Other processes aren’t affected.</p>
<p>This is a deeper topic that you’ll understand thoroughly over time. But in the
limited scope of this tutorial, understand that you want to perform any risky
or complex process initialization in <code class="docutils literal notranslate"><span class="pre">init/1</span></code>.</p>
</div>
<div class="section" id="handling-client-connections">
<h3>Handling Client Connections<a class="headerlink" href="#handling-client-connections" title="Permalink to this headline">¶</a></h3>
<p>As soon as our server is initialized, it <em>handles</em> incoming client
connections.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">handle_task</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">dispatch_client</span><span class="p">(</span><span class="n">wait_for_client</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)),</span>
    <span class="p">{</span><span class="n">repeat</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}.</span>
</pre></div>
</div>
<p>The declarative nature of Erlang makes this very clear: you handle a client
connection by waiting for one, then dispatching it. Then you repeat.</p>
<p>Neat!</p>
<p>The rest of the module is “fake” – we wanted to stub this out so we can get a
feel for the server behavior. The next step is to implement the missing
functionality.</p>
</div>
<div class="section" id="listening-for-clients">
<h3>Listening for Clients<a class="headerlink" href="#listening-for-clients" title="Permalink to this headline">¶</a></h3>
<p>Servers that listen for incoming TCP connections on a particular port can use
Erlang’s <code class="docutils literal notranslate"><span class="pre">gen_tcp</span></code> module. Here’s the modified version of our <code class="docutils literal notranslate"><span class="pre">listen/1</span></code>
function:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">listen</span><span class="p">(</span><span class="nv">Port</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">listen</span><span class="p">(</span><span class="nv">Port</span><span class="p">,</span> <span class="p">[{</span><span class="n">reuseaddr</span><span class="p">,</span> <span class="n">true</span><span class="p">}]),</span>
    <span class="nv">Socket</span><span class="p">.</span>
</pre></div>
</div>
<p>This function will open a listen socket on the specified Port.</p>
<p>Refer to <a class="reference external" href="http://www.erlang.org/doc/man/gen_tcp.html#listen-2">gen_tcp:listen/2</a> for more details.</p>
</div>
<div class="section" id="waiting-for-client-connections">
<h3>Waiting for Client Connections<a class="headerlink" href="#waiting-for-client-connections" title="Permalink to this headline">¶</a></h3>
<p>Once our server is listening on the specified port, it can wait for incoming
client connections using <a class="reference external" href="http://www.erlang.org/doc/man/gen_tcp.html#accept-1">gen_tcp:accept/1</a>. Here’s the modified version of
our <code class="docutils literal notranslate"><span class="pre">wait_for_client/1</span></code> function:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">wait_for_client</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Client</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">accept</span><span class="p">(</span><span class="nv">Socket</span><span class="p">),</span>
    <span class="nv">Client</span><span class="p">.</span>
</pre></div>
</div>
<p>This function will block until a client establishes a TCP connection with our
server port. It’s okay to block here – the server is a <em>task</em>, which means
it runs in a separate process. It can happily block, waiting for connections,
while other Erlang processes run free!</p>
</div>
<div class="section" id="testing-the-server">
<h3>Testing The Server<a class="headerlink" href="#testing-the-server" title="Permalink to this headline">¶</a></h3>
<p>Now that our server can listen to a port and accept incoming client
connections, let’s test it!</p>
<p>Start a new server in your running Erlang shell: <a class="footnote-reference" href="#s2" id="id9">[9]</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">S2</span><span class="p">}</span> <span class="o">=</span> <span class="n">mydb_server</span><span class="p">:</span><span class="n">start_link</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span><span class="o">.</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you made a mistake and something went wrong, don’t fear! The
easiest way to get back to a clean slate is to exit the shell by typing
<code class="docutils literal notranslate"><span class="pre">CTRL-C</span></code> twice and restarting it using <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">shell</span></code>. Then re-type what
you missed above.</p>
</div>
<p>If everything went according to plan, you’re server is actually listening on
port 1234!</p>
<p>Test the server using <code class="docutils literal notranslate"><span class="pre">telnet</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ telnet 127.0.0.1 1234
</pre></div>
</div>
<p>In your Erlang shell, note the output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TODO</span><span class="p">:</span> <span class="n">dispatch</span> <span class="n">client</span> <span class="c1">#Port&lt;0.XXX&gt;</span>
</pre></div>
</div>
<p>Your server is dealing with real life client connections! Only it’s not – we
still have to implement that part.</p>
<p>Close your <code class="docutils literal notranslate"><span class="pre">telnet</span></code> session <a class="footnote-reference" href="#close-telnet" id="id10">[10]</a>.</p>
</div>
</div>
<div class="section" id="client-handlers">
<h2>Client Handlers<a class="headerlink" href="#client-handlers" title="Permalink to this headline">¶</a></h2>
<p>Now that we’re accepting client connection, let’s create something to handle
them!</p>
<p>We want another task type – we want to interact with clients until they close
the connection or there’s an error.</p>
<p>Create the file <code class="docutils literal notranslate"><span class="pre">~/e2-tutorial/src/mydb_client_handler.erl</span></code>:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">mydb_client_handler</span><span class="p">).</span>

<span class="p">-</span><span class="ni">behavior</span><span class="p">(</span><span class="n">e2_task</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start_link</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">handle_task</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">terminate</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>

<span class="nf">start_link</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">e2_task</span><span class="p">:</span><span class="nf">start_link</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">).</span>

<span class="nf">handle_task</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">gen_tcp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="s">&quot;hello, and goodbye!</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">),</span>
    <span class="p">{</span><span class="n">stop</span><span class="p">,</span> <span class="n">normal</span><span class="p">}.</span>

<span class="nf">terminate</span><span class="p">(_</span><span class="nv">Reason</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">Socket</span><span class="p">).</span>
</pre></div>
</div>
<p>Like our initial server, this task stubs out the functionality we want. Instead
of providing database services, it prints a snarky messages and closes the
connection.</p>
<div class="section" id="using-the-handler">
<h3>Using the Handler<a class="headerlink" href="#using-the-handler" title="Permalink to this headline">¶</a></h3>
<p>To see this new task in action, we need to start it when we get a new client
connection. It’s easy!</p>
<p>In <code class="docutils literal notranslate"><span class="pre">mydb_server.erl</span></code>, modify <code class="docutils literal notranslate"><span class="pre">dispatch_client/1</span></code> as follows:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">dispatch_client</span><span class="p">(</span><span class="nv">Client</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">_}</span> <span class="o">=</span> <span class="nn">mydb_client_handler</span><span class="p">:</span><span class="nf">start_link</span><span class="p">(</span><span class="nv">Client</span><span class="p">).</span>
</pre></div>
</div>
<p>Compile your changes.</p>
<p>Now when we get a new client connection, we’ll start a task to handle it.</p>
<p>Before we can test this, we need to stop our running server – we left some
client connections in a wait state by not closing them explicitly in our
previous iteration. In the Erlang shell, stop the server this way:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">exit</span><span class="p">(</span><span class="n">S2</span><span class="p">,</span> <span class="n">shutdown</span><span class="p">)</span><span class="o">.</span>
<span class="o">**</span> <span class="n">exception</span> <span class="n">exit</span><span class="p">:</span> <span class="n">shutdown</span>
</pre></div>
</div>
<p>Now we can start a new server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">S3</span><span class="p">}</span> <span class="o">=</span> <span class="n">mydb_server</span><span class="p">:</span><span class="n">start_link</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span><span class="o">.</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="o">&lt;</span><span class="mf">0.</span><span class="n">XX</span><span class="o">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">}</span>
</pre></div>
</div>
<p>Let’s see what happens now when we connect using <code class="docutils literal notranslate"><span class="pre">telnet</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ telnet 127.0.0.1 1234
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is &#39;^]&#39;.
hello, and goodbye!
Connection closed by foreign host.
</pre></div>
</div>
<p>Well!</p>
</div>
<div class="section" id="client-handler-stub">
<h3>Client Handler Stub<a class="headerlink" href="#client-handler-stub" title="Permalink to this headline">¶</a></h3>
<p>So far, this process has been very iterative – we start with something small,
see if it works, then enhance it until we get what we want.</p>
<p>In that tradition, let’s modify our client handler just enough to get a feel
for a client interaction.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">mydb_client_handler.erl</span></code> modify <code class="docutils literal notranslate"><span class="pre">handle_task/1</span></code> as follows:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">handle_task</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_command_line</span><span class="p">(</span><span class="n">read_line</span><span class="p">(</span><span class="nv">Socket</span><span class="p">),</span> <span class="nv">Socket</span><span class="p">).</span>
</pre></div>
</div>
<p>We’re using two yet-to-be-defined functions: <code class="docutils literal notranslate"><span class="pre">read_line/1</span></code> and
<code class="docutils literal notranslate"><span class="pre">handle_command_line/2</span></code>. This illustrates how functions can be used to
symbolically represent your problem/solution. This is a single line function
that makes it absolutely clear what it means to handle a “client task”. We
don’t yet know what it means to “handle a command line”, but we know – or more
accurately, we’re <em>declaring</em> – that the task is to handle a single command,
which is derived from a single line read from a socket.</p>
<p>Let’s define the two missing functions. First <code class="docutils literal notranslate"><span class="pre">read_line/1</span></code>:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">read_line</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">inet</span><span class="p">:</span><span class="nf">setopts</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="p">[{</span><span class="n">active</span><span class="p">,</span> <span class="n">false</span><span class="p">},</span> <span class="p">{</span><span class="n">packet</span><span class="p">,</span> <span class="n">line</span><span class="p">}]),</span>
    <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">recv</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span>
</pre></div>
</div>
<p>This is standard TCP network programming: we’re setting socket options and
reading some data. You can read about socket options in <a class="reference external" href="http://www.erlang.org/doc/man/inet.html#setopts-2">inet:setopts/2</a></p>
<p>Next, let’s stub out some basic command handling support in
<code class="docutils literal notranslate"><span class="pre">handle_command_line/2</span></code>:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">handle_command_line</span><span class="p">({</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Data</span><span class="p">},</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;### Got </span><span class="si">~p</span><span class="s"> from client</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Data</span><span class="p">]),</span>
    <span class="p">{</span><span class="n">repeat</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">};</span>
<span class="nf">handle_command_line</span><span class="p">({</span><span class="n">error</span><span class="p">,</span> <span class="nv">Err</span><span class="p">},</span> <span class="p">_</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">stop</span><span class="p">,</span> <span class="p">{</span><span class="n">socket_err</span><span class="p">,</span> <span class="nv">Err</span><span class="p">}}.</span>
</pre></div>
</div>
<p>This function handles two cases:</p>
<ul class="simple">
<li>If we get data from a client, print it so we can see what it looks like</li>
<li>If we get an error, stop the task with an error condition (we’ll see in a
moment what this looks like)</li>
</ul>
<p>Now let’s test the behavior using <code class="docutils literal notranslate"><span class="pre">telnet</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Lines prefixed by <code class="docutils literal notranslate"><span class="pre">&gt;&gt;</span></code> below indicate text that you should
type, followed by <code class="docutils literal notranslate"><span class="pre">ENTER</span></code>. For example, when you see <code class="docutils literal notranslate"><span class="pre">&gt;&gt;</span> <span class="pre">GET</span> <span class="pre">msg</span></code> type
<code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">msg</span></code> and then press <code class="docutils literal notranslate"><span class="pre">ENTER</span></code> If you don’t see <code class="docutils literal notranslate"><span class="pre">&gt;&gt;</span></code> your version of
telnet may be using a different prompt, or no problem at all. In this case,
just type what follows <code class="docutils literal notranslate"><span class="pre">&gt;&gt;</span></code> and press <code class="docutils literal notranslate"><span class="pre">ENTER</span></code>.</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ telnet 127.0.0.1 1234
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is &#39;^]&#39;.
&gt;&gt; GET msg
&gt;&gt; PUT msg This is a test message
&gt;&gt; DEL msg
&gt;&gt; ^]
&gt;&gt; quit
Connection closed.
</pre></div>
</div>
<p>Note what happened in your Erlang shell:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">### Got &quot;GET msg\r\n&quot; from client</span>
<span class="c1">### Got &quot;PUT msg This is a test message\r\n&quot; from client</span>
<span class="c1">### Got &quot;DEL msg\r\n&quot; from client</span>
<span class="o">&gt;</span>
<span class="o">=</span><span class="n">ERROR</span> <span class="n">REPORT</span><span class="o">====</span> <span class="mi">25</span><span class="o">-</span><span class="n">Mar</span><span class="o">-</span><span class="mi">2012</span><span class="p">::</span><span class="mi">12</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">01</span> <span class="o">===</span>
<span class="o">**</span> <span class="n">Generic</span> <span class="n">server</span> <span class="o">&lt;</span><span class="mf">0.45</span><span class="o">.</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">terminating</span>
<span class="o">...</span>
<span class="o">**</span> <span class="n">Reason</span> <span class="k">for</span> <span class="n">termination</span> <span class="o">==</span>
<span class="o">**</span> <span class="p">{</span><span class="n">socket_err</span><span class="p">,</span><span class="n">closed</span><span class="p">}</span>
</pre></div>
</div>
<p>We can see our commands very clearly represented as Erlang strings. That should
be pretty easy to handle!</p>
<p>When we closed the client telnet session, we got a big error. We can see that
the <em>reason</em> for the error was that the socket was closed.</p>
<p>We’ll use this information in the next step to better handle these cases.</p>
</div>
<div class="section" id="more-client-handler">
<h3>More Client Handler<a class="headerlink" href="#more-client-handler" title="Permalink to this headline">¶</a></h3>
<p>Now that we know what to expect from client connections, let’s think about what
sort of functionality we need:</p>
<ul class="simple">
<li>We need to handle specific commands</li>
<li>To handle specific commands, we’ll need to parse the command line</li>
<li>We should gracefully handle the case when the socket is closed by the client
– let’s just stop the task normally</li>
</ul>
<p>Here’s the new <code class="docutils literal notranslate"><span class="pre">handle_command_line/2</span></code> function:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">handle_command_line</span><span class="p">({</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Data</span><span class="p">},</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_command</span><span class="p">(</span><span class="n">parse_command</span><span class="p">(</span><span class="nv">Data</span><span class="p">),</span> <span class="nv">Socket</span><span class="p">);</span>
<span class="nf">handle_command_line</span><span class="p">({</span><span class="n">error</span><span class="p">,</span> <span class="n">closed</span><span class="p">},</span> <span class="p">_</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">stop</span><span class="p">,</span> <span class="n">normal</span><span class="p">}.</span>
</pre></div>
</div>
<p>As with <code class="docutils literal notranslate"><span class="pre">handle_task/2</span></code>, this function is short and clearly communicates the
logic of handling a command line.</p>
<p>Let’s fill in some more!</p>
<p>Our command parsing is pretty simple. Commands look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">COMMAND</span><span class="o">&gt;</span> <span class="n">SPACE</span> <span class="o">&lt;</span><span class="n">ARGUMENT</span><span class="o">&gt;</span> <span class="n">CRLF</span>
</pre></div>
</div>
<p>We can use Erlang’s excellent regular expression support for this. Add the
these new functions to <code class="docutils literal notranslate"><span class="pre">mydb_client_handler.erl</span></code>:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">parse_command</span><span class="p">(</span><span class="nv">Data</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_command_re_result</span><span class="p">(</span>
      <span class="nn">re</span><span class="p">:</span><span class="nf">run</span><span class="p">(</span><span class="nv">Data</span><span class="p">,</span> <span class="s">&quot;(.*?) (.*)</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[{</span><span class="n">capture</span><span class="p">,</span> <span class="n">all_but_first</span><span class="p">,</span> <span class="n">list</span><span class="p">}])).</span>

<span class="nf">handle_command_re_result</span><span class="p">({</span><span class="n">match</span><span class="p">,</span> <span class="p">[</span><span class="nv">Command</span><span class="p">,</span> <span class="nv">Arg</span><span class="p">]})</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">Command</span><span class="p">,</span> <span class="nv">Arg</span><span class="p">};</span>
<span class="nf">handle_command_re_result</span><span class="p">(</span><span class="n">nomatch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">error</span><span class="p">.</span>
</pre></div>
</div>
<p>For more information on the options used, see <a class="reference external" href="http://www.erlang.org/doc/man/re.html#run-3">re:run/3</a>.</p>
<p>Note that we again used a <em>handler</em> function to translate the results of
<code class="docutils literal notranslate"><span class="pre">re:run/3</span></code> to something appropriate for our use. We could easily have used a
case statement – but the function more formally represents our logic.</p>
<p>Next, we need to handle specific commands. Based on our design sketch above, we
support “GET”, “PUT” and “DEL”. Anything else is an error.</p>
<p>Here’s what <code class="docutils literal notranslate"><span class="pre">handle_command/2</span></code> looks like:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">handle_command</span><span class="p">({</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="nv">Key</span><span class="p">},</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_reply</span><span class="p">(</span><span class="n">db_get</span><span class="p">(</span><span class="nv">Key</span><span class="p">),</span> <span class="nv">Socket</span><span class="p">);</span>
<span class="nf">handle_command</span><span class="p">({</span><span class="s">&quot;PUT&quot;</span><span class="p">,</span> <span class="nv">KeyVal</span><span class="p">},</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_reply</span><span class="p">(</span><span class="n">db_put</span><span class="p">(</span><span class="n">split_keyval</span><span class="p">(</span><span class="nv">KeyVal</span><span class="p">)),</span> <span class="nv">Socket</span><span class="p">);</span>
<span class="nf">handle_command</span><span class="p">({</span><span class="s">&quot;DEL&quot;</span><span class="p">,</span> <span class="nv">Key</span><span class="p">},</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_reply</span><span class="p">(</span><span class="n">db_del</span><span class="p">(</span><span class="nv">Key</span><span class="p">),</span> <span class="nv">Socket</span><span class="p">);</span>
<span class="nf">handle_command</span><span class="p">(_,</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_reply</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">).</span>
</pre></div>
</div>
<p>This is the heart and soul of the task – it takes input from the user,
performs the appropriate action, and routes the reply back to the user.</p>
<p>Note that “PUT” is slightly different from the other operations – it treats
the single argument as both a key and a value.</p>
<p>Here’s the logic that breaks that single value into two:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">split_keyval</span><span class="p">(</span><span class="nv">KeyVal</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_keyval_parts</span><span class="p">(</span><span class="nn">re</span><span class="p">:</span><span class="nf">split</span><span class="p">(</span><span class="nv">KeyVal</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="p">[{</span><span class="n">return</span><span class="p">,</span> <span class="n">list</span><span class="p">},</span> <span class="p">{</span><span class="n">parts</span><span class="p">,</span> <span class="mi">2</span><span class="p">}])).</span>

<span class="nf">handle_keyval_parts</span><span class="p">([</span><span class="nv">Key</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">Key</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">};</span>
<span class="nf">handle_keyval_parts</span><span class="p">([</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Val</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Val</span><span class="p">}.</span>
</pre></div>
</div>
<p>Just two more parts to go!</p>
<ul class="simple">
<li>db_xxx functions, which handle the database operations</li>
<li>Reply handler, which encodes our responses and sends them to the client</li>
</ul>
<p>Here are some stubs for the database operations – we’ll figure out those
details later:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">db_get</span><span class="p">(</span><span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="s">&quot;You asked for &quot;</span> <span class="o">++</span> <span class="nv">Key</span><span class="p">}.</span>

<span class="nf">db_put</span><span class="p">({_</span><span class="nv">Key</span><span class="p">,</span> <span class="p">_</span><span class="nv">Val</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="n">ok</span><span class="p">.</span>

<span class="nf">db_del</span><span class="p">(_</span><span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">ok</span><span class="p">.</span>
</pre></div>
</div>
<p>We already have the database support – so plugging this in later will be easy!</p>
<p>Finally, here’s the logic for handling replies:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">handle_reply</span><span class="p">(</span><span class="nv">Reply</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">send_reply</span><span class="p">(</span><span class="nv">Reply</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">),</span>
    <span class="p">{</span><span class="n">repeat</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}.</span>
</pre></div>
</div>
<p>You’re probably sick of these short, trivial functions that use other short,
trivial functions!</p>
<p>Let’s take a moment to review why we write code this way:</p>
<ul class="simple">
<li>Short, trivial functions are easier to read and understand</li>
<li>Short, trivial functions usually solve trivial problems</li>
<li>Trivial problems are easy to solve!</li>
</ul>
<p>The real problem is of course finding problems that are trivial. Most problems
in software are initially hard. But by working to break the problems into
smaller, integral sub problems, we can eventually get to the point we’re
just solving those elusive easy ones!</p>
<p>That’s exactly what we’ve been doing here in building a database. By
systematically thinking about concrete, solvable problems, we slowly but surely
chain together trivial solutions that add up to something quite complex.</p>
<p>Confucius say, “Enough philosophy – let’s finish our code already!”</p>
<p>Here’s the last piece of our nearly finished task module:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">send_reply</span><span class="p">({</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Val</span><span class="p">},</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">gen_tcp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;+&quot;</span><span class="p">,</span> <span class="nv">Val</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">]);</span>
<span class="nf">send_reply</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">gen_tcp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="s">&quot;+OK</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nf">send_reply</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">gen_tcp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="s">&quot;-ERROR</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span>
</pre></div>
</div>
<p>This function handles three cases:</p>
<ul class="simple">
<li>Sending a value</li>
<li>Sending an “OK”</li>
<li>Sending an “ERROR”</li>
</ul>
<p>We’ve made a lot of changes in this round, so here’s the complete module as it
stands currently.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">mydb_client_handler</span><span class="p">).</span>

<span class="p">-</span><span class="ni">behavior</span><span class="p">(</span><span class="n">e2_task</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start_link</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">handle_task</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">terminate</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>

<span class="nf">start_link</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">e2_task</span><span class="p">:</span><span class="nf">start_link</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">).</span>

<span class="nf">handle_task</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_command_line</span><span class="p">(</span><span class="n">read_line</span><span class="p">(</span><span class="nv">Socket</span><span class="p">),</span> <span class="nv">Socket</span><span class="p">).</span>

<span class="nf">read_line</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">inet</span><span class="p">:</span><span class="nf">setopts</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="p">[{</span><span class="n">active</span><span class="p">,</span> <span class="n">false</span><span class="p">},</span> <span class="p">{</span><span class="n">packet</span><span class="p">,</span> <span class="n">line</span><span class="p">}]),</span>
    <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">recv</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span>

<span class="nf">handle_command_line</span><span class="p">({</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Data</span><span class="p">},</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_command</span><span class="p">(</span><span class="n">parse_command</span><span class="p">(</span><span class="nv">Data</span><span class="p">),</span> <span class="nv">Socket</span><span class="p">);</span>
<span class="nf">handle_command_line</span><span class="p">({</span><span class="n">error</span><span class="p">,</span> <span class="n">closed</span><span class="p">},</span> <span class="p">_</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">stop</span><span class="p">,</span> <span class="n">normal</span><span class="p">}.</span>

<span class="nf">parse_command</span><span class="p">(</span><span class="nv">Data</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_command_re_result</span><span class="p">(</span>
      <span class="nn">re</span><span class="p">:</span><span class="nf">run</span><span class="p">(</span><span class="nv">Data</span><span class="p">,</span> <span class="s">&quot;(.*?) (.*)</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[{</span><span class="n">capture</span><span class="p">,</span> <span class="n">all_but_first</span><span class="p">,</span> <span class="n">list</span><span class="p">}])).</span>

<span class="nf">handle_command_re_result</span><span class="p">({</span><span class="n">match</span><span class="p">,</span> <span class="p">[</span><span class="nv">Command</span><span class="p">,</span> <span class="nv">Arg</span><span class="p">]})</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">Command</span><span class="p">,</span> <span class="nv">Arg</span><span class="p">};</span>
<span class="nf">handle_command_re_result</span><span class="p">(</span><span class="n">nomatch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">error</span><span class="p">.</span>

<span class="nf">handle_command</span><span class="p">({</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="nv">Key</span><span class="p">},</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_reply</span><span class="p">(</span><span class="n">db_get</span><span class="p">(</span><span class="nv">Key</span><span class="p">),</span> <span class="nv">Socket</span><span class="p">);</span>
<span class="nf">handle_command</span><span class="p">({</span><span class="s">&quot;PUT&quot;</span><span class="p">,</span> <span class="nv">KeyVal</span><span class="p">},</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_reply</span><span class="p">(</span><span class="n">db_put</span><span class="p">(</span><span class="n">split_keyval</span><span class="p">(</span><span class="nv">KeyVal</span><span class="p">)),</span> <span class="nv">Socket</span><span class="p">);</span>
<span class="nf">handle_command</span><span class="p">({</span><span class="s">&quot;DEL&quot;</span><span class="p">,</span> <span class="nv">Key</span><span class="p">},</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_reply</span><span class="p">(</span><span class="n">db_del</span><span class="p">(</span><span class="nv">Key</span><span class="p">),</span> <span class="nv">Socket</span><span class="p">);</span>
<span class="nf">handle_command</span><span class="p">(_,</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_reply</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">).</span>

<span class="nf">split_keyval</span><span class="p">(</span><span class="nv">KeyVal</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_keyval_parts</span><span class="p">(</span><span class="nn">re</span><span class="p">:</span><span class="nf">split</span><span class="p">(</span><span class="nv">KeyVal</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="p">[{</span><span class="n">return</span><span class="p">,</span> <span class="n">list</span><span class="p">},</span> <span class="p">{</span><span class="n">parts</span><span class="p">,</span> <span class="mi">2</span><span class="p">}])).</span>

<span class="nf">handle_keyval_parts</span><span class="p">([</span><span class="nv">Key</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">Key</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">};</span>
<span class="nf">handle_keyval_parts</span><span class="p">([</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Val</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Val</span><span class="p">}.</span>

<span class="nf">db_get</span><span class="p">(</span><span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="s">&quot;You asked for &quot;</span> <span class="o">++</span> <span class="nv">Key</span><span class="p">}.</span>

<span class="nf">db_put</span><span class="p">({_</span><span class="nv">Key</span><span class="p">,</span> <span class="p">_</span><span class="nv">Val</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="n">ok</span><span class="p">.</span>

<span class="nf">db_del</span><span class="p">(_</span><span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">ok</span><span class="p">.</span>

<span class="nf">handle_reply</span><span class="p">(</span><span class="nv">Reply</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">send_reply</span><span class="p">(</span><span class="nv">Reply</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">),</span>
    <span class="p">{</span><span class="n">repeat</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}.</span>

<span class="nf">send_reply</span><span class="p">({</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Val</span><span class="p">},</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">gen_tcp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;+&quot;</span><span class="p">,</span> <span class="nv">Val</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">]);</span>
<span class="nf">send_reply</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">gen_tcp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="s">&quot;+OK</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nf">send_reply</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">gen_tcp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="s">&quot;-ERROR</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span>

<span class="nf">terminate</span><span class="p">(_</span><span class="nv">Reason</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">Socket</span><span class="p">).</span>
</pre></div>
</div>
<p>Compile the changes and let’s test them with <code class="docutils literal notranslate"><span class="pre">telnet</span></code>.</p>
<p>We need to restart the server because of the error from our last test. In your
running Erlang shell, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">S4</span><span class="p">}</span> <span class="o">=</span> <span class="n">mydb_server</span><span class="p">:</span><span class="n">start_link</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span><span class="o">.</span>
</pre></div>
</div>
<p>Using <code class="docutils literal notranslate"><span class="pre">telnet</span></code>, let’s connect to our server and try out some commands. As
before, lines starting with <code class="docutils literal notranslate"><span class="pre">&gt;&gt;</span></code> represent commands that you type,
followed by <code class="docutils literal notranslate"><span class="pre">ENTER</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ telnet 127.0.0.1 1234
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is &#39;^]&#39;.
&gt;&gt; GET msg
+You asked for msg
&gt;&gt; PUT msg hello
+OK
&gt;&gt; DEL msg
+OK
&gt;&gt; BAD_CMD
-ERROR
&gt;&gt; ^]
&gt;&gt; quit
Connection closed.
</pre></div>
</div>
<p>Wow! Aside from the fact that our values aren’t stored or retrieved, this is a
pretty cool database!</p>
</div>
</div>
<div class="section" id="data-access">
<h2>Data Access<a class="headerlink" href="#data-access" title="Permalink to this headline">¶</a></h2>
<p>Without thinking too hard about this, how would we implement the <code class="docutils literal notranslate"><span class="pre">db_xxx</span></code>
functions in <code class="docutils literal notranslate"><span class="pre">mydb_client_handler</span></code>?</p>
<p>Let’s grab our example code from earlier and just paste into one of the
functions – just to see what it would look like:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">db_get</span><span class="p">(</span><span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">mydb_db</span><span class="p">:</span><span class="nb">get</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">).</span>
</pre></div>
</div>
<p>That looks perfect! Except that <code class="docutils literal notranslate"><span class="pre">Db</span></code> isn’t defined. How are we going to solve
this? Erlang, after all, doesn’t have global variables – we can’t just write
to a shared heap and grab a reference to our database!</p>
<p>There are two ways to deal with this:</p>
<ul class="simple">
<li>When a client handler process is started using
<code class="docutils literal notranslate"><span class="pre">mydb_client_handler:start_link</span></code>, specify a database reference as an
additional argument</li>
<li>Run a registered database service within the application</li>
</ul>
<p>This is a legitimate design consideration – either approach is valid and would
work. Let’s think through the issues.</p>
<ul class="simple">
<li>If we added a <code class="docutils literal notranslate"><span class="pre">Db</span></code> argument to <code class="docutils literal notranslate"><span class="pre">mydb_client_handler:start_link</span></code>, we’re
making it slightly harder to start a handler task. Generally, in Erlang, you
want to make it easier to start processes, not harder.</li>
<li>The database file is a shared resources – if we let each task have direct
access to it, we might run into concurrency related problems.</li>
<li>Since e2 is “service oriented”, maybe creating a separate data access
<em>service</em> won’t be that hard. Hmmm.</li>
</ul>
<p>Registered services are Erlang’s equivalent of <a class="reference external" href="http://en.wikipedia.org/wiki/Singleton_pattern">singletons</a>. This is really
what we want – something that’s “just there” that we can use. Our code could
then look like this:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">db_get</span><span class="p">(</span><span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">mydb_data</span><span class="p">:</span><span class="nb">get</span><span class="p">(</span><span class="nv">Key</span><span class="p">).</span>
</pre></div>
</div>
</div>
<div class="section" id="data-server">
<h2>Data Server<a class="headerlink" href="#data-server" title="Permalink to this headline">¶</a></h2>
<p>Building services in e2 is easy.</p>
<p>Create the file <code class="docutils literal notranslate"><span class="pre">~/e2-tutorial/src/mydb_data.erl</span></code>:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">mydb_data</span><span class="p">).</span>

<span class="p">-</span><span class="ni">behavior</span><span class="p">(</span><span class="n">e2_service</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start_link</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="nb">get</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="nb">put</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">del</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle_msg</span><span class="o">/</span><span class="mi">3</span><span class="p">]).</span>

<span class="nf">start_link</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">e2_service</span><span class="p">:</span><span class="nf">start_link</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="nv">File</span><span class="p">,</span> <span class="p">[</span><span class="n">registered</span><span class="p">]).</span>

<span class="nb">get</span><span class="p">(</span><span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">e2_service</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">{</span><span class="nb">get</span><span class="p">,</span> <span class="nv">Key</span><span class="p">}).</span>

<span class="nb">put</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">e2_service</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">{</span><span class="nb">put</span><span class="p">,</span> <span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">}).</span>

<span class="nf">del</span><span class="p">(</span><span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">e2_service</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">{</span><span class="n">del</span><span class="p">,</span> <span class="nv">Key</span><span class="p">}).</span>

<span class="nf">init</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">open_db</span><span class="p">(</span><span class="nv">File</span><span class="p">)}.</span>

<span class="nf">open_db</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Db</span><span class="p">}</span> <span class="o">=</span> <span class="nn">mydb_db</span><span class="p">:</span><span class="nf">open</span><span class="p">(</span><span class="nv">File</span><span class="p">),</span>
    <span class="nv">Db</span><span class="p">.</span>

<span class="nf">handle_msg</span><span class="p">({</span><span class="nb">get</span><span class="p">,</span> <span class="nv">Key</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Db</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nn">mydb_db</span><span class="p">:</span><span class="nb">get</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">),</span> <span class="nv">Db</span><span class="p">};</span>
<span class="nf">handle_msg</span><span class="p">({</span><span class="nb">put</span><span class="p">,</span> <span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Db</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nn">mydb_db</span><span class="p">:</span><span class="nb">put</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">),</span> <span class="nv">Db</span><span class="p">};</span>
<span class="nf">handle_msg</span><span class="p">({</span><span class="n">del</span><span class="p">,</span> <span class="nv">Key</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Db</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nn">mydb_db</span><span class="p">:</span><span class="nf">del</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">),</span> <span class="nv">Db</span><span class="p">}.</span>
</pre></div>
</div>
<p>We’ll take some time to go over each part of this module in detail, but first,
let’s test it!</p>
<p>Compile the code and start a server in your running Erlang shell:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">mydb_data</span><span class="p">:</span><span class="n">start_link</span><span class="p">(</span><span class="s2">&quot;/tmp/test.db&quot;</span><span class="p">)</span><span class="o">.</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span><span class="n">XX</span><span class="p">,</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">}</span>
</pre></div>
</div>
<p>Now try some database operations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">mydb_data</span><span class="p">:</span><span class="k">del</span><span class="p">(</span><span class="s2">&quot;msg&quot;</span><span class="p">)</span><span class="o">.</span>
<span class="n">ok</span>
<span class="o">&gt;</span> <span class="n">mydb_data</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;msg&quot;</span><span class="p">)</span><span class="o">.</span>
<span class="n">error</span>
<span class="o">&gt;</span> <span class="n">mydb_data</span><span class="p">:</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;msg&quot;</span><span class="p">,</span> <span class="s2">&quot;My database is nigh!&quot;</span><span class="p">)</span><span class="o">.</span>
<span class="n">ok</span>
<span class="o">&gt;</span> <span class="n">mydb_data</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;msg&quot;</span><span class="p">)</span><span class="o">.</span>
<span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="s2">&quot;My database is nigh!&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>Provided we can start this service, our client handlers can use this API
without worrying about a <code class="docutils literal notranslate"><span class="pre">Db</span></code> reference. This is the value of a <em>service</em> –
as long as it’s running, just use it!</p>
<p>Let’s take a moment to review this new service of ours.</p>
<div class="section" id="service-behavior">
<h3>Service Behavior<a class="headerlink" href="#service-behavior" title="Permalink to this headline">¶</a></h3>
<p>We know our data service is a <em>service</em> because it says so:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">behavior</span><span class="p">(</span><span class="n">e2_service</span><span class="p">).</span>
</pre></div>
</div>
<p>As with the <code class="docutils literal notranslate"><span class="pre">e2_task</span></code> behavior declaration, it not only helps us understand
the type of module, it tells the Erlang compiler to check for required
functions. In this case, we need to export <code class="docutils literal notranslate"><span class="pre">handle_msg/3</span></code>.</p>
</div>
<div class="section" id="service-exports">
<h3>Service Exports<a class="headerlink" href="#service-exports" title="Permalink to this headline">¶</a></h3>
<p>We see here the separate listing of <em>public</em> functions and <em>callback</em>
functions.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start_link</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="nb">get</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="nb">put</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">del</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle_msg</span><span class="o">/</span><span class="mi">3</span><span class="p">]).</span>
</pre></div>
</div>
</div>
<div class="section" id="starting-the-service">
<h3>Starting the Service<a class="headerlink" href="#starting-the-service" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">start_link</span></code> function is used to start the service. It’s similar to that
of <code class="docutils literal notranslate"><span class="pre">mydb_client_handler</span></code>, but it applies to <code class="docutils literal notranslate"><span class="pre">e2_service</span></code> types, rather than
<code class="docutils literal notranslate"><span class="pre">e2_task</span></code> types.</p>
<p>Note the additional <code class="docutils literal notranslate"><span class="pre">registered</span></code> option provided in the third argument. This
tells e2 to register the service using its module name. This can be used to
make calls to the registered process – we’ll see how this works when we look
more closely at the <em>public API</em> functions below.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">start_link</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">e2_service</span><span class="p">:</span><span class="nf">start_link</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="nv">File</span><span class="p">,</span> <span class="p">[</span><span class="n">registered</span><span class="p">]).</span>
</pre></div>
</div>
</div>
<div class="section" id="initializing-the-service">
<h3>Initializing the Service<a class="headerlink" href="#initializing-the-service" title="Permalink to this headline">¶</a></h3>
<p>Our service provides access to a single database. We open this database as a
part of the <em>service initialization</em>. This is what we did manually when we
experimented with the <code class="docutils literal notranslate"><span class="pre">mydb_db</span></code> module – we first opened a database and then
worked with that reference to test the operations.</p>
<p>In this case, we’ll open the database and use that value as our initial service
<em>state</em>.</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">init</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="n">open_db</span><span class="p">(</span><span class="nv">File</span><span class="p">)}.</span>
</pre></div>
</div>
<p>If you recall, <code class="docutils literal notranslate"><span class="pre">init/1</span></code> is called in the context of the <em>server</em> process –
not the process that called <code class="docutils literal notranslate"><span class="pre">start_link</span></code>. This is subtle, but important – if
something goes wrong during initialization, the caller of <code class="docutils literal notranslate"><span class="pre">start_link</span></code> won’t
be affected because of Erlang’s process isolation guarantees.</p>
</div>
<div class="section" id="public-api">
<h3>Public API<a class="headerlink" href="#public-api" title="Permalink to this headline">¶</a></h3>
<p>The public API is used by client of the service. These functions are called in
the context of <em>client</em> processes – not the server process.</p>
<p>Each public API function looks similar:</p>
<ul class="simple">
<li>Use <code class="docutils literal notranslate"><span class="pre">e2_service:call/2</span></code> to send a message to the server process</li>
<li><code class="docutils literal notranslate"><span class="pre">?MODULE</span></code> refers to the registered service (an alias for <code class="docutils literal notranslate"><span class="pre">mydb_data</span></code> in
this case)</li>
</ul>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nb">get</span><span class="p">(</span><span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">e2_service</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">{</span><span class="nb">get</span><span class="p">,</span> <span class="nv">Key</span><span class="p">}).</span>

<span class="nb">put</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">e2_service</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">{</span><span class="nb">put</span><span class="p">,</span> <span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">}).</span>

<span class="nf">del</span><span class="p">(</span><span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">e2_service</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">{</span><span class="n">del</span><span class="p">,</span> <span class="nv">Key</span><span class="p">}).</span>
</pre></div>
</div>
<p>If we had not registered the process when we created it, we would have required
an explicit process reference. Because the process is registered, we can use
its registered name instead. This is how you can provide “global” or
“singleton” style processes in your Erlang applications.</p>
<p>We’ll see later how to automatically start services when your application
starts.</p>
</div>
<div class="section" id="handling-messages">
<h3>Handling Messages<a class="headerlink" href="#handling-messages" title="Permalink to this headline">¶</a></h3>
<p>The public API functions use <code class="docutils literal notranslate"><span class="pre">e2_service:call/2</span></code> to send messages to the
registered service. The service process <em>handles</em> these messages in
<code class="docutils literal notranslate"><span class="pre">handle_msg/3</span></code>.</p>
<p>You can see each of the three message sent by the public API functions handled here:OB</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">handle_msg</span><span class="p">({</span><span class="nb">get</span><span class="p">,</span> <span class="nv">Key</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Db</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nn">mydb_db</span><span class="p">:</span><span class="nb">get</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">),</span> <span class="nv">Db</span><span class="p">};</span>
<span class="nf">handle_msg</span><span class="p">({</span><span class="nb">put</span><span class="p">,</span> <span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Db</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nn">mydb_db</span><span class="p">:</span><span class="nb">put</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">),</span> <span class="nv">Db</span><span class="p">};</span>
<span class="nf">handle_msg</span><span class="p">({</span><span class="n">del</span><span class="p">,</span> <span class="nv">Key</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Db</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nn">mydb_db</span><span class="p">:</span><span class="nf">del</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">),</span> <span class="nv">Db</span><span class="p">}.</span>
</pre></div>
</div>
<p>Our service “serves” access to a single database (opened in <code class="docutils literal notranslate"><span class="pre">init/1</span></code> and
passed as the third argument to <code class="docutils literal notranslate"><span class="pre">handle_msg/3</span></code>). Each of the three
operations, <code class="docutils literal notranslate"><span class="pre">get</span></code>, <code class="docutils literal notranslate"><span class="pre">put</span></code>, and <code class="docutils literal notranslate"><span class="pre">del</span></code> are trivially passed along to the
<code class="docutils literal notranslate"><span class="pre">mydb_db</span></code> module.</p>
</div>
</div>
<div class="section" id="using-the-data-service">
<h2>Using the Data Service<a class="headerlink" href="#using-the-data-service" title="Permalink to this headline">¶</a></h2>
<p>We’re only moments away from connecting the dots to get a functional database!</p>
<p>Modify the three <code class="docutils literal notranslate"><span class="pre">db_xxx</span></code> functions in <code class="docutils literal notranslate"><span class="pre">mydb_client_handler.erl</span></code> to look
like this:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">db_get</span><span class="p">(</span><span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">mydb_data</span><span class="p">:</span><span class="nb">get</span><span class="p">(</span><span class="nv">Key</span><span class="p">).</span>

<span class="nf">db_put</span><span class="p">({</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Val</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nn">mydb_data</span><span class="p">:</span><span class="nb">put</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Val</span><span class="p">).</span>

<span class="nf">db_del</span><span class="p">(</span><span class="nv">Key</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">mydb_data</span><span class="p">:</span><span class="nf">del</span><span class="p">(</span><span class="nv">Key</span><span class="p">).</span>
</pre></div>
</div>
<p>Compile your changes and get ready for some fun!</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ telnet 127.0.0.1 1234
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is &#39;^]&#39;.
&gt;&gt; DEL msg
+OK
&gt;&gt; GET msg
-ERROR
&gt;&gt; PUT msg It is alive!
+OK
&gt;&gt; GET msg
+It is alive!
&gt;&gt; ^]
&gt;&gt; quit
Connection closed.
</pre></div>
</div>
<p>High five!</p>
</div>
<div class="section" id="putting-it-all-together">
<h2>Putting It All Together<a class="headerlink" href="#putting-it-all-together" title="Permalink to this headline">¶</a></h2>
<p>We actually have a bona fide, multi-client, socket based database server!</p>
<p>But we still have some work ahead of us. To illustrate, we’re going to shut
down the Erlang VM and rebuild our various services.</p>
<p>Shut down the Erlang shell by typing CTRL-C twice (^C ^C).</p>
<p>Restart the shell:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make shell
</pre></div>
</div>
<p>Let’s try to connect using our <code class="docutils literal notranslate"><span class="pre">telnet</span></code> client:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ telnet 127.0.0.1 1234
Trying 127.0.0.1...
telnet: Unable to connect to remote host: Connection refused
</pre></div>
</div>
<p>There’s no server running! Let’s start one in the Erlang shell:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">mydb_server</span><span class="p">:</span><span class="n">start_link</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span><span class="o">.</span>
</pre></div>
</div>
<p>Try connecting with <code class="docutils literal notranslate"><span class="pre">telnet</span></code> again:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ telnet 127.0.0.1 1234
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is &#39;^]&#39;.
</pre></div>
</div>
<p>We’re in!</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">telnet</span></code> session, “GET” a value:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="n">GET</span> <span class="n">msg</span>
<span class="n">Connection</span> <span class="n">closed</span> <span class="n">by</span> <span class="n">foreign</span> <span class="n">host</span><span class="o">.</span>
</pre></div>
</div>
<p>Something bad! Check the Erlang shell – you’ll see an error report that looks
something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">=</span><span class="n">ERROR</span> <span class="n">REPORT</span><span class="o">====</span> <span class="mi">25</span><span class="o">-</span><span class="n">Mar</span><span class="o">-</span><span class="mi">2012</span><span class="p">::</span><span class="mi">17</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mi">37</span> <span class="o">===</span>
<span class="o">**</span> <span class="n">Generic</span> <span class="n">server</span> <span class="o">&lt;</span><span class="mf">0.38</span><span class="o">.</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">terminating</span>
<span class="o">...</span>
<span class="o">**</span> <span class="n">exception</span> <span class="n">error</span><span class="p">:</span> <span class="p">{</span><span class="n">noproc</span><span class="p">,</span>
                      <span class="p">{</span><span class="n">gen_server</span><span class="p">,</span><span class="n">call</span><span class="p">,</span>
                         <span class="p">[</span><span class="n">mydb_data</span><span class="p">,{</span><span class="s1">&#39;$call&#39;</span><span class="p">,{</span><span class="n">get</span><span class="p">,</span><span class="s2">&quot;msg&quot;</span><span class="p">}},</span><span class="n">infinity</span><span class="p">]}}</span>
</pre></div>
</div>
<p>This is fancy Erlang speak for “the process you tried to call wasn’t running!”</p>
<p>The problem is that our client handler relies on <code class="docutils literal notranslate"><span class="pre">mydb_data</span></code> to be
started. But we never started it!</p>
<p>That’s the nature of service oriented design – to use a service, it must be
running. If it’s not running, you can’t use it.</p>
<p>Let’s fix this by stating the data service. In the Erlang shell, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">mydb_data</span><span class="p">:</span><span class="n">start_link</span><span class="p">(</span><span class="s2">&quot;/tmp/data.db&quot;</span><span class="p">)</span><span class="o">.</span>
</pre></div>
</div>
<p>We also have to start our server again, because it crashed when the handler
crashed. In the Erlang shell:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">mydb_server</span><span class="p">:</span><span class="n">start_link</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span><span class="o">.</span>
</pre></div>
</div>
<p>Now connect again with <code class="docutils literal notranslate"><span class="pre">telnet</span></code> and experiment with the socket protocol.</p>
<p>It works!</p>
<p>But if only there was a way to do all this startup work automatically.</p>
<div class="section" id="application-startup">
<h3>Application Startup<a class="headerlink" href="#application-startup" title="Permalink to this headline">¶</a></h3>
<p>In your editor, open the file <code class="docutils literal notranslate"><span class="pre">~/e2-tutorial/src/mydb_app.erl</span></code>.</p>
<p>This file was created automatically when you created the <code class="docutils literal notranslate"><span class="pre">mydb</span></code> project.</p>
<p>It even has a little TODO note for you!</p>
<p>The purpose of this module is to list top-level processes that are started when
the application starts. Perfect!</p>
<p>Modify the file to look like this:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">mydb_app</span><span class="p">).</span>

<span class="p">-</span><span class="ni">behavior</span><span class="p">(</span><span class="n">e2_application</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="nf">init</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">[{</span><span class="n">mydb_data</span><span class="p">,</span> <span class="n">start_link</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;/tmp/data.db&quot;</span><span class="p">]},</span>
          <span class="p">{</span><span class="n">mydb_server</span><span class="p">,</span> <span class="n">start_link</span><span class="p">,</span> <span class="p">[</span><span class="mi">1234</span><span class="p">]}</span>
         <span class="p">]}.</span>
</pre></div>
</div>
<p>This tells e2, when you start the <code class="docutils literal notranslate"><span class="pre">mydb</span></code> application, make sure that
<code class="docutils literal notranslate"><span class="pre">mydb_server</span></code> and <code class="docutils literal notranslate"><span class="pre">mydb_data</span></code> are started.</p>
<p>Compile you changes and let’s test!</p>
<p>Shut down Erlang by typing CTRL-C twice.</p>
<p>Restart it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make shell
</pre></div>
</div>
<p>In the Erlang shell, start <code class="docutils literal notranslate"><span class="pre">mydb</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">mydb</span><span class="p">:</span><span class="n">start</span><span class="p">()</span><span class="o">.</span>
<span class="n">ok</span>
</pre></div>
</div>
<p>Now test the database server using <code class="docutils literal notranslate"><span class="pre">telnet</span></code>.</p>
<p>You can also execute <code class="docutils literal notranslate"><span class="pre">mydb:stop().</span></code> to stop the database and confirm that the
server is no longer running.</p>
</div>
<div class="section" id="application-configuration">
<h3>Application Configuration<a class="headerlink" href="#application-configuration" title="Permalink to this headline">¶</a></h3>
<p>Our database is looking great! But we have a problem – we hard coded some
settings in <code class="docutils literal notranslate"><span class="pre">mydb_app</span></code>:</p>
<ul class="simple">
<li>The database file is “/tmp/test.db”</li>
<li>The server port is 1234</li>
</ul>
<p>Those values are fine for testing, but we need to support external
configuration to let database administrators setup the database on differently.</p>
<p>Replace the hard coded port and file name in <code class="docutils literal notranslate"><span class="pre">mydb_app:init/0</span></code> with some
functions – we can use these to lookup the values:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">init</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">[{</span><span class="n">mydb_data</span><span class="p">,</span> <span class="n">start_link</span><span class="p">,</span> <span class="p">[</span><span class="n">db_file</span><span class="p">()]},</span>
          <span class="p">{</span><span class="n">mydb_server</span><span class="p">,</span> <span class="n">start_link</span><span class="p">,</span> <span class="p">[</span><span class="n">server_port</span><span class="p">()]}</span>
         <span class="p">]}.</span>
</pre></div>
</div>
<p>Next, add the two functions – these in turn lookup application configuration:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">db_file</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="n">app_config</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="o">?</span><span class="nv">DEFAULT_DB_FILE</span><span class="p">).</span>

<span class="nf">server_port</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="n">app_config</span><span class="p">(</span><span class="n">server_port</span><span class="p">,</span> <span class="o">?</span><span class="nv">DEFAULT_PORT</span><span class="p">).</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">?DEFAULT_DB_FILE</span></code> and <code class="docutils literal notranslate"><span class="pre">?DEFAULT_SERVER_PORT</span></code> are references to <em>macros</em> –
it’s a good idea to use macros for this type of information because it calls
attention to their “hard coding”.</p>
<p>Here are their definitions – you can put them just under the <code class="docutils literal notranslate"><span class="pre">export</span></code> list
at the top of the module:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">DEFAULT_DB_FILE</span><span class="p">,</span> <span class="s">&quot;/var/lib/mydb/data.db&quot;</span><span class="p">).</span>
<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">DEFAULT_PORT</span><span class="p">,</span> <span class="mi">1234</span><span class="p">).</span>
</pre></div>
</div>
<p>Finally, here’s the application configuration lookup support:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">app_config</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Default</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_app_env</span><span class="p">(</span><span class="nn">application</span><span class="p">:</span><span class="nf">get_env</span><span class="p">(</span><span class="nv">Name</span><span class="p">),</span> <span class="nv">Default</span><span class="p">).</span>

<span class="nf">handle_app_env</span><span class="p">({</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Value</span><span class="p">},</span> <span class="p">_</span><span class="nv">Default</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Value</span><span class="p">;</span>
<span class="nf">handle_app_env</span><span class="p">(</span><span class="n">undefined</span><span class="p">,</span> <span class="nv">Default</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Default</span><span class="p">.</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">application:get_env/1</span></code> is used to lookup a configuration value for the
current application. We’ll show how this is used shortly. Refer to
<a class="reference external" href="http://www.erlang.org/doc/apps/kernel/application.html#get_env-1">application:get_env/1</a> for more details.</p>
<p>Here’s the complete <code class="docutils literal notranslate"><span class="pre">mydb_app</span></code> module:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">mydb_app</span><span class="p">).</span>

<span class="p">-</span><span class="ni">behavior</span><span class="p">(</span><span class="n">e2_application</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>

<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">DEFAULT_DB_FILE</span><span class="p">,</span> <span class="s">&quot;/var/lib/mydb/data.db&quot;</span><span class="p">).</span>
<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">DEFAULT_PORT</span><span class="p">,</span> <span class="mi">1234</span><span class="p">).</span>

<span class="nf">init</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">[{</span><span class="n">mydb_data</span><span class="p">,</span> <span class="n">start_link</span><span class="p">,</span> <span class="p">[</span><span class="n">db_file</span><span class="p">()]},</span>
          <span class="p">{</span><span class="n">mydb_server</span><span class="p">,</span> <span class="n">start_link</span><span class="p">,</span> <span class="p">[</span><span class="n">server_port</span><span class="p">()]}</span>
         <span class="p">]}.</span>

<span class="nf">db_file</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="n">app_config</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="o">?</span><span class="nv">DEFAULT_DB_FILE</span><span class="p">).</span>

<span class="nf">server_port</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="n">app_config</span><span class="p">(</span><span class="n">server_port</span><span class="p">,</span> <span class="o">?</span><span class="nv">DEFAULT_PORT</span><span class="p">).</span>

<span class="nf">app_config</span><span class="p">(</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Default</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_app_env</span><span class="p">(</span><span class="nn">application</span><span class="p">:</span><span class="nf">get_env</span><span class="p">(</span><span class="nv">Name</span><span class="p">),</span> <span class="nv">Default</span><span class="p">).</span>

<span class="nf">handle_app_env</span><span class="p">({</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Value</span><span class="p">},</span> <span class="p">_</span><span class="nv">Default</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Value</span><span class="p">;</span>
<span class="nf">handle_app_env</span><span class="p">(</span><span class="n">undefined</span><span class="p">,</span> <span class="nv">Default</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Default</span><span class="p">.</span>
</pre></div>
</div>
</div>
<div class="section" id="config-files">
<h3>Config Files<a class="headerlink" href="#config-files" title="Permalink to this headline">¶</a></h3>
<p>Now that our application reads application configuration for the server port
and database file, let’s start our application with some custom settings.</p>
<p>Create the file <code class="docutils literal notranslate"><span class="pre">~/e2-tutorial/test.config</span></code> as follows:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">[{</span><span class="n">mydb</span><span class="p">,</span> <span class="p">[{</span><span class="n">server_port</span><span class="p">,</span> <span class="mi">2222</span><span class="p">},</span> <span class="p">{</span><span class="n">db_file</span><span class="p">,</span> <span class="s">&quot;test.db&quot;</span><span class="p">}]}].</span>
</pre></div>
</div>
<p>This is how application configuration is specified. In this case, <code class="docutils literal notranslate"><span class="pre">mydb</span></code> has
a list of two properties: <code class="docutils literal notranslate"><span class="pre">server_port</span></code> and <code class="docutils literal notranslate"><span class="pre">db_file</span></code>.</p>
<p>Save the file and quit the Erlang shell.</p>
<p>Start the Erlang shell again, but this time, specify some additional options
that will tell the Erlang VM to read your new configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make opts=&quot;-config test&quot; shell
</pre></div>
</div>
<p>In the Erlang shell, start <code class="docutils literal notranslate"><span class="pre">mydb</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">mydb</span><span class="p">:</span><span class="n">start</span><span class="p">()</span><span class="o">.</span>
</pre></div>
</div>
<p>Not, try connecting to the original port – 1234 – using <code class="docutils literal notranslate"><span class="pre">telnet</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ telnet 127.0.0.1 1234
Trying 127.0.0.1...
telnet: Unable to connect to remote host: Connection refused
</pre></div>
</div>
<p>That’s good news! The server should be running on port 2222 – that’s what’s in
the <code class="docutils literal notranslate"><span class="pre">test.config</span></code>. Let’s try again, this time with the correct port:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ telnet 127.0.0.1 2222
Trying 127.0.0.1...
Connected to 127.0.0.1.
</pre></div>
</div>
</div>
</div>
<div class="section" id="fault-tolerance">
<h2>Fault Tolerance<a class="headerlink" href="#fault-tolerance" title="Permalink to this headline">¶</a></h2>
<p>We’re almost done!</p>
<p>But before we claim victory, let’s put Erlang’s famed “fault tolerance” to the
test.</p>
<p>As we’ll soon see, there’s a serious design flaw in our application!</p>
<p>With your database server running, connect to it with two different <code class="docutils literal notranslate"><span class="pre">telnet</span></code>
sessions. Each session should see the changes made by the other. Try it!</p>
<p>Next, start the <code class="docutils literal notranslate"><span class="pre">appmon</span></code> application from the Erlang shell:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">appmon</span><span class="p">:</span><span class="n">start</span><span class="p">()</span><span class="o">.</span>
</pre></div>
</div>
<p>This will bring up a graphical application that shows looks something like
this:</p>
<img alt="_images/appmon-1.png" src="_images/appmon-1.png" />
<p>Click on the <strong>mydb</strong> button.</p>
<p>This will open a new window, which displayed a tree of running processes:</p>
<img alt="_images/appmon-2.png" src="_images/appmon-2.png" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The process IDs (i.e. the values that look like <code class="docutils literal notranslate"><span class="pre">&lt;0.XX.0&gt;</span></code>) may be
different in your <code class="docutils literal notranslate"><span class="pre">appmon</span></code> windows.</p>
</div>
<p>Looking at the <code class="docutils literal notranslate"><span class="pre">mydb_app</span></code> node, we can see two children: <code class="docutils literal notranslate"><span class="pre">mydb_data</span></code> and an
unregistered service (process ID <code class="docutils literal notranslate"><span class="pre">&lt;0.45.0&gt;</span></code> in the example above). These
correspond to the top-level processes specified in <code class="docutils literal notranslate"><span class="pre">mydb_app</span></code>.</p>
<p>The unregistered process (i.e. <code class="docutils literal notranslate"><span class="pre">&lt;0.45.0&gt;</span></code> above) is the <code class="docutils literal notranslate"><span class="pre">mydb_server</span></code> task
that is listening on port 2222. It’s two children are the client handlers that
are servicing your two telnet sessions.</p>
<p>We can use <code class="docutils literal notranslate"><span class="pre">appmon</span></code> to kill one of the two <code class="docutils literal notranslate"><span class="pre">telnet</span></code> handlers. If our
application is well designed – only one <code class="docutils literal notranslate"><span class="pre">telnet</span></code> session will be affected.</p>
<p>Let’s try it! Click <strong>Kill</strong> in the process window and click on one of the two
client handler processes (e.g. either <code class="docutils literal notranslate"><span class="pre">&lt;0.46.0&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">&lt;0.47.0&gt;</span></code> above).</p>
<p>What happened?</p>
<p>Rats! <em>Both</em> <code class="docutils literal notranslate"><span class="pre">telnet</span></code> sessions were closed! That’s not fault tolerant – it’s
fault <em>intolerant</em>!</p>
<p>This is the problem: the <code class="docutils literal notranslate"><span class="pre">start_link</span></code> functions that we’ve been using to
start processes create <em>links</em> between the starting process and the new
process. When two processes are linked, when one process terminates abnormally,
the other terminates <a class="footnote-reference" href="#trap-exit" id="id11">[11]</a>.</p>
<p>In our case, the <code class="docutils literal notranslate"><span class="pre">mydb_server</span></code> task <em>links</em> to handler tasks. If <em>any</em>
handler task terminates abnormally, the server will terminate, along with every
other handler task! It’s a cascading mess!</p>
<p>This is the design flaw: processes should not typically start other
processes. Instead, they should call specialized start functions on
<em>supervisors</em>. New processes are then linked to their supervisors, which
specialize in dealing with process termination.</p>
<div class="section" id="client-handler-supervisor">
<h3>Client Handler Supervisor<a class="headerlink" href="#client-handler-supervisor" title="Permalink to this headline">¶</a></h3>
<p>Let’s fix this problem using a supervisor. Here’s what we want to do:</p>
<ul class="simple">
<li>Create supervisor that specializes in starting and supervising
<code class="docutils literal notranslate"><span class="pre">mydb_client_handler</span></code> tasks</li>
<li>Start that supervisor as a top-level process for our app</li>
<li>Modify <code class="docutils literal notranslate"><span class="pre">mydb_server</span></code> to use the new supervisor to start client handlers,
rather than start them itself</li>
</ul>
<p>Create a new file <code class="docutils literal notranslate"><span class="pre">~/e2-tutorial/src/mydb_client_handler_sup.erl</span></code> that looks
like this:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">mydb_client_handler_sup</span><span class="p">).</span>

<span class="p">-</span><span class="ni">behavior</span><span class="p">(</span><span class="n">e2_task_supervisor</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start_link</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_handler</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="nf">start_link</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nn">e2_task_supervisor</span><span class="p">:</span><span class="nf">start_link</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">mydb_client_handler</span><span class="p">,</span> <span class="p">[</span><span class="n">registered</span><span class="p">]).</span>

<span class="nf">start_handler</span><span class="p">(</span><span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">e2_task_supervisor</span><span class="p">:</span><span class="nf">start_task</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">[</span><span class="nv">Socket</span><span class="p">]).</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">start_link/0</span></code> starts an <code class="docutils literal notranslate"><span class="pre">e2_task_supervisor</span></code>:</p>
<ul class="simple">
<li>The first argument is the supervisor callback module</li>
<li>The second argument is the task module <code class="docutils literal notranslate"><span class="pre">mydb_client_handler</span></code> – the
supervisor will start tasks using this module’s <code class="docutils literal notranslate"><span class="pre">start_link</span></code> function</li>
<li>The third argument is a list of options containing <code class="docutils literal notranslate"><span class="pre">registered</span></code> – like
<code class="docutils literal notranslate"><span class="pre">mydb_data</span></code> this will registered a single named process that can be
referenced using <code class="docutils literal notranslate"><span class="pre">mydb_client_handler_sup</span></code></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">start_handler/1</span></code> starts a new <em>handler</em>, which will be supervised by the
task supervisor. The default behavior of task supervisors is to <em>not</em> restart
children, regardless of how they terminate. This is what we want in this case
(restarting with the original client socket would not be the right course in
many cases).</p>
<ul class="simple">
<li>The first argument to <code class="docutils literal notranslate"><span class="pre">e2_task_supervisor:start_task/2</span></code> is the supervisor
reference</li>
<li>The second argument is the list of arguments to pass to the task module’s
<code class="docutils literal notranslate"><span class="pre">start_link</span></code> function – in this case, we’re starting the new client
handler with the client socket as the single argument</li>
</ul>
<p>With our new task supervisor ready, let’s ensure that it’s available when the
application is started.</p>
<p>Modify <code class="docutils literal notranslate"><span class="pre">mydb_app:init/0</span></code> to look like this:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">init</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">[{</span><span class="n">mydb_data</span><span class="p">,</span> <span class="n">start_link</span><span class="p">,</span> <span class="p">[</span><span class="n">db_file</span><span class="p">()]},</span>
          <span class="p">{</span><span class="n">mydb_client_handler_sup</span><span class="p">,</span> <span class="p">[</span><span class="n">supervisor</span><span class="p">]},</span>
          <span class="p">{</span><span class="n">mydb_server</span><span class="p">,</span> <span class="n">start_link</span><span class="p">,</span> <span class="p">[</span><span class="n">server_port</span><span class="p">()]}</span>
         <span class="p">]}.</span>
</pre></div>
</div>
<p>The order the processes are listed in is important because it determines the
order in which the processes are started. In this case, we want to make sure
both <code class="docutils literal notranslate"><span class="pre">mydb_data</span></code> and <code class="docutils literal notranslate"><span class="pre">mydb_client_handler_sup</span></code> are available before we
start accepting client connections with <code class="docutils literal notranslate"><span class="pre">mydb_server</span></code>.</p>
<p>Finally, let’s modify <code class="docutils literal notranslate"><span class="pre">mydb_server:dispatch_client/1</span></code> to use the supervisor
instead of starting the client handler itself:</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">dispatch_client</span><span class="p">(</span><span class="nv">Client</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">_}</span> <span class="o">=</span> <span class="nn">mydb_client_handler_sup</span><span class="p">:</span><span class="nf">start_handler</span><span class="p">(</span><span class="nv">Client</span><span class="p">).</span>
</pre></div>
</div>
</div>
<div class="section" id="actual-fault-tolerance">
<h3>Actual Fault Tolerance<a class="headerlink" href="#actual-fault-tolerance" title="Permalink to this headline">¶</a></h3>
<p>Now that we’ve fixed our fault <em>intolerance</em> problem, let’s run our test again:</p>
<ul>
<li><p class="first">Close the Erlang shell</p>
</li>
<li><p class="first">Start the Erlang shell using this command (this will automatically start
<code class="docutils literal notranslate"><span class="pre">mydb</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make opts=&quot;-config test -s mydb&quot; shell
</pre></div>
</div>
</li>
<li><p class="first">Connect the server on port 2222 using two separate <code class="docutils literal notranslate"><span class="pre">telnet</span></code> clients</p>
</li>
<li><p class="first">Start <code class="docutils literal notranslate"><span class="pre">appmon</span></code> in the Erlang shell:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">appmon</span><span class="p">:</span><span class="n">start</span><span class="p">()</span><span class="o">.</span>
</pre></div>
</div>
</li>
<li><p class="first">Click the <strong>mydb</strong> button in the top-level <code class="docutils literal notranslate"><span class="pre">appmon</span></code> window</p>
</li>
</ul>
<p>You should now see this hierarchy:</p>
<img alt="_images/appmon-3.png" src="_images/appmon-3.png" />
<p>Note that now the two client handler processes are children of
<code class="docutils literal notranslate"><span class="pre">mydb_client_handler_sup</span></code>. This is what you want to see in your Erlang
process hierarchies – a relatively flat structure with all processes running
under a supervisor.</p>
<p>Click <strong>Kill</strong> and then click one of the two client handler processes
(e.g. <code class="docutils literal notranslate"><span class="pre">&lt;0.47.0&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">&lt;0.48.0&gt;</span></code> above). Note now that only the related
<code class="docutils literal notranslate"><span class="pre">telnet</span></code> session is effected – the other session is still running!</p>
<p>Now that’s <em>actual</em> fault tolerance!</p>
</div>
</div>
<div class="section" id="wrapping-up">
<h2>Wrapping Up<a class="headerlink" href="#wrapping-up" title="Permalink to this headline">¶</a></h2>
<p>Believe it or not, we just created a serviceable multi-user, socket based
database in just over 130 lines of code!</p>
<p>Seriously – that just happened!</p>
<p>But more importantly, you know a <em>lot</em> about writing quality Erlang using e2:</p>
<ul class="simple">
<li>Erlang code is organized in :doc_`applications &lt;applications&gt;` – yours is
called <code class="docutils literal notranslate"><span class="pre">mydb</span></code></li>
<li>e2 <a class="reference internal" href="tasks.html"><span class="doc">tasks</span></a> are used to perform work</li>
<li>e2 <a class="reference internal" href="services.html"><span class="doc">services</span></a> are used to provide functionality to client in
your app</li>
<li>You can assemble tasks services together to write complex software</li>
<li>Supervisors are used to manage processes</li>
</ul>
<p>You even got a taste of Erlang coding style:</p>
<ul class="simple">
<li>Functions should be short and focused, solving small, trivial problems</li>
<li>Complex functionality can be broken into smaller, simpler pieces</li>
<li>You don’t need to approach complex systems with an over arching design – you
can take it step by step, solving obvious problems, and eventually end up
with something that works very well</li>
</ul>
<div class="section" id="what-we-didn-t-cover">
<h3>What We Didn’t Cover<a class="headerlink" href="#what-we-didn-t-cover" title="Permalink to this headline">¶</a></h3>
<div class="section" id="data-validation">
<h4>Data Validation<a class="headerlink" href="#data-validation" title="Permalink to this headline">¶</a></h4>
<p>Wait a minute! We’re not performing any of that special validation we talked
about earlier! That was the whole point of writing our own database for crying
out loud!</p>
<p>This is coming soon.</p>
<p>Here’s what’s planned:</p>
<ul class="simple">
<li>Modify <code class="docutils literal notranslate"><span class="pre">mydb_data</span></code> to enforce our custom validation, returning <code class="docutils literal notranslate"><span class="pre">{error,</span>
<span class="pre">Msg}</span></code> on an invalid <code class="docutils literal notranslate"><span class="pre">put</span></code></li>
<li>Modify <code class="docutils literal notranslate"><span class="pre">mydb_client_handler</span></code> to handle <code class="docutils literal notranslate"><span class="pre">{error,</span> <span class="pre">Msg}</span></code> results, which
sends the result to the client ala “-ERROR invalid value” on an invalid “PUT”</li>
</ul>
<p>You can try it now, if you’re dare!</p>
<p>Cheats…</p>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">send_reply</span><span class="p">({</span><span class="n">error</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">},</span> <span class="nv">Socket</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">gen_tcp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;-ERROR &quot;</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">]);</span>
</pre></div>
</div>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">handle_msg</span><span class="p">({</span><span class="nb">put</span><span class="p">,</span> <span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Db</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">handle_validate_put</span><span class="p">(</span><span class="n">validate_put</span><span class="p">(</span><span class="nv">Value</span><span class="p">),</span> <span class="nv">Key</span><span class="p">,</span> <span class="nv">Db</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-erlang notranslate"><div class="highlight"><pre><span></span><span class="nf">validate_put</span><span class="p">(</span><span class="nv">Value</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">validate_length</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="nv">Value</span><span class="p">),</span> <span class="nv">Value</span><span class="p">).</span>

<span class="nf">validate_length</span><span class="p">(</span><span class="nv">Len</span><span class="p">,</span> <span class="nv">Value</span><span class="p">)</span> <span class="k">when</span> <span class="nv">Len</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">true</span><span class="p">,</span> <span class="nv">Value</span><span class="p">};</span>
<span class="nf">validate_length</span><span class="p">(_,</span> <span class="p">_)</span> <span class="o">-&gt;</span> <span class="n">false</span><span class="p">.</span>

<span class="nf">handle_validate_put</span><span class="p">({</span><span class="n">true</span><span class="p">,</span> <span class="nv">Value</span><span class="p">},</span> <span class="nv">Key</span><span class="p">,</span> <span class="nv">Db</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nn">mydb_db</span><span class="p">:</span><span class="nb">put</span><span class="p">(</span><span class="nv">Db</span><span class="p">,</span> <span class="nv">Key</span><span class="p">,</span> <span class="nv">Value</span><span class="p">),</span> <span class="nv">Db</span><span class="p">};</span>
<span class="nf">handle_validate_put</span><span class="p">(</span><span class="n">false</span><span class="p">,</span> <span class="p">_</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Db</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="s">&quot;invalid value&quot;</span><span class="p">},</span> <span class="nv">Db</span><span class="p">}.</span>
</pre></div>
</div>
</div>
<div class="section" id="application-packaging">
<h4>Application Packaging<a class="headerlink" href="#application-packaging" title="Permalink to this headline">¶</a></h4>
<p>We haven’t covered what’s involved in packaging and deploying your
application. We’ll update this tutorial once that’s been sorted out!</p>
<p>In the mean time, you can deploy the source code to the application and run
this command to build it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make
</pre></div>
</div>
<p>You can run this command to run the application as a daemon:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ config=test ./start
</pre></div>
</div>
<p>This will use the local <code class="docutils literal notranslate"><span class="pre">test.config</span></code> for the application configuration. If
you wanted to use different settings – e.g. <code class="docutils literal notranslate"><span class="pre">production.config</span></code> – you’d
create that file and use this to start the application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ config=production ./start
</pre></div>
</div>
<p>You can check the status of the application this way:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ./status
</pre></div>
</div>
<p>You can stop the application this way:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ./stop
</pre></div>
</div>
<p>And you can check the application logs by looking in the <code class="docutils literal notranslate"><span class="pre">log</span></code> directory!</p>
</div>
</div>
</div>
<div class="section" id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h2>
<p>This of course is an introductory tutorial, so there’s a <em>lot</em> left out! Stay
tuned to <a class="reference external" href="http://e2project.org">e2project.org</a> for new tutorials, examples, and what not!</p>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="durability" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Database “durability” of of course a very difficult problem –
but we’ll do our best!</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="mydb" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><code class="docutils literal notranslate"><span class="pre">mydb</span></code> is the name of the <a class="reference internal" href="applications.html"><span class="doc">Erlang application</span></a>
name. Application names are typically used to prefix every module in the
application, and should be short but descriptive.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="e2-reloader" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><code class="docutils literal notranslate"><span class="pre">e2_reloader</span></code> is merely a renamed version of the
<a class="reference external" href="https://github.com/mochi/mochiweb">Mochiweb</a> <code class="docutils literal notranslate"><span class="pre">reloader</span></code> module.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="make-quick" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td>The default <code class="docutils literal notranslate"><span class="pre">make</span></code> target compiles your project code along
with all of its dependencies. The <code class="docutils literal notranslate"><span class="pre">quick</span></code> target skips these dependencies,
which will save you time during normal development.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="rr" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[5]</a></td><td>This isn’t strictly necessary for this example, but it makes it easier
to read the record returned by <code class="docutils literal notranslate"><span class="pre">file:read_file_info/2</span></code>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="reassign" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[6]</a></td><td>Seasoned Erlangers might at first blance at this assignment –
it looks like we’re reassigning a variable, which in Erlang is a no-no. But
in fact, you can’t <em>redefine</em> a variable – and in this case <code class="docutils literal notranslate"><span class="pre">Db</span></code> is
always the <code class="docutils literal notranslate"><span class="pre">dets</span></code> table name “/tmp/test.db”.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="api-consistency" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[7]</a></td><td>Erlang has a number of inconsistencies in the
implementation of its APIs. Don’t be surprised to see wildly differing
function names and return value conventions in the core modules!</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="callbacks" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[8]</a></td><td>If you’re used to Java, <em>callbacks</em> are similar to
<code class="docutils literal notranslate"><span class="pre">abstract</span> <span class="pre">protected</span></code> methods that are called by super classes and
implemented by concrete subclasseses.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="s2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[9]</a></td><td>Here’s a case where we can’t reuse the same variable in Erlang. Our
previous server was named <code class="docutils literal notranslate"><span class="pre">Server</span></code> and was a process ID. Subsequent
process IDs will be different, so if we tried to assign the new server to
<code class="docutils literal notranslate"><span class="pre">{ok,</span> <span class="pre">Server}</span></code> we’d get a bad match! Try it if you want.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="close-telnet" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[10]</a></td><td>You typically close telnet by issuing the telnet escape
character (e.g. <code class="docutils literal notranslate"><span class="pre">^]</span></code> + <code class="docutils literal notranslate"><span class="pre">ENTER</span></code>) and typing <code class="docutils literal notranslate"><span class="pre">quit</span></code> + <code class="docutils literal notranslate"><span class="pre">ENTER</span></code>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="trap-exit" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id11">[11]</a></td><td>Linked processes can guard against termination by “trapping”
exits – but isn’t how we’re going to solve this particular problem.</td></tr>
</tbody>
</table>
</div>
</div>



<!--
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'e2project';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
-->

 <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'e2project'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/e2logo.png" alt="Logo"/>
            </a></p>
<h3><a href="index.html">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="overview.html">e2 Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="quick_start.html">e2 Quick Start</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">e2 Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="source.html">Source Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="contact.html">Contact</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="applications.html">e2 Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="services.html">e2 Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks.html">e2 Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="supervisors.html">e2 Supervisors</a></li>
<li class="toctree-l1"><a class="reference internal" href="facades.html">Facades</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="erlang.html">Erlang Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="erlang_modules.html">Batteries Included</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="e2_vs_otp.html">e2 vs OTP</a></li>
<li class="toctree-l1"><a class="reference internal" href="principles.html">Design Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="todo.html">To Do</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>API Reference</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="api/index.html">Overview</a></li>

<li class="toctree-l1"><a class="reference internal" href="api/e2_application.html">e2_application</a></li>

<li class="toctree-l1"><a class="reference internal" href="api/e2_application_sup.html">e2_application_sup</a></li>

<li class="toctree-l1"><a class="reference internal" href="api/e2_log.html">e2_log</a></li>

<li class="toctree-l1"><a class="reference internal" href="api/e2_log_handler.html">e2_log_handler</a></li>

<li class="toctree-l1"><a class="reference internal" href="api/e2_opt.html">e2_opt</a></li>

<li class="toctree-l1"><a class="reference internal" href="api/e2_publisher.html">e2_publisher</a></li>

<li class="toctree-l1"><a class="reference internal" href="api/e2_service.html">e2_service</a></li>

<li class="toctree-l1"><a class="reference internal" href="api/e2_service_impl.html">e2_service_impl</a></li>

<li class="toctree-l1"><a class="reference internal" href="api/e2_simple_task.html">e2_simple_task</a></li>

<li class="toctree-l1"><a class="reference internal" href="api/e2_supervisor.html">e2_supervisor</a></li>

<li class="toctree-l1"><a class="reference internal" href="api/e2_task.html">e2_task</a></li>

<li class="toctree-l1"><a class="reference internal" href="api/e2_task_impl.html">e2_task_impl</a></li>

<li class="toctree-l1"><a class="reference internal" href="api/e2_task_supervisor.html">e2_task_supervisor</a></li>
</ul>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="erlang.html" title="Erlang Overview"
             >next</a> |</li>
        <li class="right" >
          <a href="quick_start.html" title="e2 Quick Start"
             >previous</a> |</li>
        <li><a href="index.html">e2</a> &raquo;</li>
          <li><a href="overview.html" >e2 Overview</a> &raquo;</li>
          <li><a href="quick_start.html" >e2 Quick Start</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Garrett Smith.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>